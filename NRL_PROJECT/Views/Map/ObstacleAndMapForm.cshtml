@model NRL_PROJECT.Models.ObstacleData

@section Styles {
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
	<link rel="stylesheet" href="https://unpkg.com/@@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css" />

	<style>
		/* STORE, NORGESKART-LIGNENDE KNAPPER */
		.map-btn-norge {
			width: 120px;
			height: 120px;
			background-color: rgba(255, 255, 255, 0.85);
			border: none;
			border-radius: 50%;
			backdrop-filter: blur(6px);
			box-shadow: 0 4px 12px rgba(0,0,0,0.30);
			display: flex;
			align-items: center;
			justify-content: center;
			transition: transform 0.15s ease, box-shadow 0.2s ease;
		}

			.map-btn-norge img {
				width: 90px;
				height: 90px;
				pointer-events: none;
				opacity: 0.95;
			}

			.map-btn-norge:active {
				transform: scale(0.92);
				background-color: rgba(0, 200, 100, 0.9);
				box-shadow: 0 0 20px rgba(0, 200, 100, 0.6);
				box-shadow: 0 2px 6px rgba(0,0,0,0.40);
			}

			.active-map-btn {
				background-color: rgba(0, 200, 100, 0.9) !important;
				box-shadow: 0 0 25px rgba(0, 200, 100, 0.6) !important;
				transform: scale(1.05);
				transition: all 0.2s ease;
			}

	</style>
}


<div class="text-center mb-10">
	<h1 class="text-4xl md:text-5xl font-extrabold text-sky-400 tracking-tight"> Registrer hinder</h1>
	<p class="text-slate-300 mt-3 text-lg">Fyll inn rapportdetaljer, legg til et bilde og marker posisjon p√• kartet.</p>
</div>

<!--  Melding om at du jobber med utkast -->
<div id="restoreNotice"
	 class="bg-yellow-600/70 text-white text-center p-4 rounded-xl mb-6 font-semibold shadow-md"
	 style="display:none;">
	‚ö†Ô∏è Et tidligere utkast ble gjenopprettet. Du kan fortsette der du slapp.
	<button id="clearDraftBtn"
			type="button"
			class="ml-3 bg-red-700 hover:bg-red-800 text-white px-3 py-1 rounded-lg font-semibold shadow-md">
		T√∏m utkast
	</button>
</div>

<form asp-action="SubmitObstacleWithLocation" asp-controller="Map" method="post" enctype="multipart/form-data" class="space-y-10">
	@Html.AntiForgeryToken()

	<!--  OBSTACLE INFORMATION -->
	<div class="bg-slate-700/60 rounded-2xl p-8 shadow-lg border border-slate-600">
		<h2 class="text-2xl font-bold text-sky-300 mb-6"> Informasjon om hinderet</h2>

		<!-- MAP SECTION -->
		<div class="bg-slate-700/60 rounded-2xl p-8 shadow-lg border border-slate-600">

			<h2 class="text-2xl md:text-3xl font-bold text-amber-400 mb-4 text-center">üó∫Ô∏è Marker hinderposisjon</h2>
			<p class="text-center text-slate-300 mb-6 text-lg">Bruk helikopterknappen for √• finne din posisjon.</p>

			<!-- STABIL KART-CONTAINER -->
			<div id="mapWrapper" class="relative rounded-xl overflow-hidden" style="height: 400px;">

				<!-- Leaflet-kartet -->
				<div id="mapDraw" class="absolute inset-0 z-0"></div>

				<!-- KNAPPESTACK (punkt, linje) -->
				<div id="mapButtons" class="absolute bottom-6 right-4 flex flex-col gap-3 z-[9999]">

					<button id="btnDrawPoint" type="button" class="map-btn-norge" aria-label="Marker punkt">
						<img src="/icons/map-pin.svg" alt="Marker hinder" />
					</button>

					<button id="btnDrawLine" type="button" class="map-btn-norge" aria-label="Tegn linje">
						<img src="/icons/line.svg" alt="Tegn linje" />
					</button>


				</div>


				<!-- Finn poisjonsknapp -->
				<div id="mapButtonsLeft" class="absolute bottom-6 left-4 z-[9999]">
					<button id="btnLocate" type="button" class="map-btn-norge" aria-label="Finn min posisjon">
						<img src="/icons/helicopter.svg" alt="Finn posisjon" />
					</button>
				</div>

				@*
				<!-- Sletteknapp  -->
				<div id="mapButtonsLeft" class="absolute top-6 left-4 z-[9999]">
					<button id="btnClearDraw" type="button" class="map-btn-norge" aria-label="Fjern tegning">
						<img src="/icons/trash-x.svg" alt="Fjern tegning" />
					</button>
				</div>
				*@
			</div>

		</div>



		<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
			<div>
				<label asp-for="ObstacleComment" class="block text-sm font-medium text-sky-200">Kommentar</label>
				<textarea asp-for="ObstacleComment" rows="3" class="mt-1 block w-full bg-slate-900 border-slate-600 text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-sky-400 focus:outline-none"></textarea>
				<span asp-validation-for="ObstacleComment" class="text-red-500 text-sm"></span>
			</div>

			<div>
				<label asp-for="ImageFile" class="block text-sm font-medium text-sky-200">Last opp bilde</label>
				<input asp-for="ImageFile"
					   type="file"
					   accept="image/*"
					   capture="environment"
					   class="mt-1 block w-full bg-slate-900 border-slate-600 text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-sky-400 focus:outline-none" />
				<span asp-validation-for="ImageFile" class="text-red-500 text-sm"></span>
			</div>
		</div>

		<!-- Hidden map fields -->
		<input type="hidden" asp-for="MapData.GeoJsonCoordinates" id="GeoJsonCoordinates" />
	</div>

	<!--  SUBMIT / CANCEL BUTTONS -->
	<div class="flex flex-col md:flex-row justify-center gap-6 mt-10">
		<button type="submit"
				class="bg-emerald-600 hover:bg-emerald-700 text-white px-10 py-4 rounded-2xl font-bold text-xl shadow-lg hover:shadow-2xl transform hover:-translate-y-1 transition-all">
			Submit Report
		</button>
		<a asp-action="Index" asp-controller="Home"
		   class="bg-red-600 hover:bg-red-700 text-white px-10 py-4 rounded-2xl font-bold text-xl shadow-lg hover:shadow-2xl transform hover:-translate-y-1 transition-all text-center">
			Cancel
		</a>
	</div>
</form>

@if (!ViewData.ModelState.IsValid)
{
	<div class="bg-red-600 text-white p-4 rounded-lg mb-6">
		<ul class="list-disc list-inside">
			@foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
			{
				<li>@error.ErrorMessage</li>
			}
		</ul>
	</div>
}

@section Scripts {
	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
	<script src="https://unpkg.com/@@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"></script>
	<script>

		// ------------------------------------------------------------
		// HELIKOPTER-IKON SOM "MIN POSISJON"
		// ------------------------------------------------------------
		const helicopterIcon = L.icon({
			iconUrl: '/icons/helicopter.svg',
			iconSize: [45, 45],
			iconAnchor: [19, 19],  // midten av ikonet
			popupAnchor: [0, -12]
		});

		// ------------------------------------------------------------
		// INITIALISER KART ‚Äì touch optimalisert, uten Leaflet/Geoman toolbar
		// ------------------------------------------------------------
		const map = L.map('mapDraw', {
			zoomControl: false,
			touchZoom: true,
			scrollWheelZoom: true,
			doubleClickZoom: true,
			boxZoom: false
		}).setView([58.333, 8.233], 13);

		L.tileLayer.wms('https://wms.geonorge.no/skwms1/wms.topo', {
			layers: 'topo',
			format: 'image/png',
			transparent: false,
			attribution: '¬© Kartverket'
		}).addTo(map);

		// Fjern alle Geoman-knapper (vi bruker v√•re egne)
		map.pm.addControls({ drawMarker: false, drawPolyline: false, editMode: false, removalMode: false });
		if (map.pm?.Toolbar) map.pm.Toolbar.removeControls();

		// Fiks for Leaflet inside flex / Tailwind container
		setTimeout(() => {
			map.invalidateSize();
		}, 300);


		// ------------------------------------------------------------
		// POSISJON ‚Äì BRUK HELIKOPTER SOM MARK√òR
		// ------------------------------------------------------------
		function locateUser() {
			map.locate({
				setView: true,
				maxZoom: 18,
				enableHighAccuracy: true,
				timeout: 10000,
				maximumAge: 0
			});
		}

		map.on("locationfound", (e) => {
			// Fjern forrige posisjonsmark√∏r
			if (window.currentPosMarker) map.removeLayer(window.currentPosMarker);
			if (window.currentPosCircle) map.removeLayer(window.currentPosCircle);

			// N√∏yaktighetssjekk
			if (e.accuracy > 200) {
				L.popup()
					.setLatLng(e.latlng)
					.setContent(`‚ö†Ô∏è Posisjon for upresis (¬±${Math.round(e.accuracy)} m).`)
					.openOn(map);
				return;
			}

			// Helikopter-mark√∏r (min posisjon)
			window.currentPosMarker = L.marker(e.latlng, { icon: helicopterIcon })
				.addTo(map)
				.bindPopup(`üöÅ Helikopterposisjon<br>N√∏yaktighet: ¬±${Math.round(e.accuracy)} m`)
				.openPopup();

			// N√∏yaktighetssirkel (kan fjernes hvis du ikke vil ha den)
			window.currentPosCircle = L.circle(e.latlng, {
				radius: Math.min(e.accuracy / 2, 100),
				color: "blue",
				weight: 2,
				opacity: 0.6,
				fillOpacity: 0.15
			}).addTo(map);
		});

		map.on("locationerror", () => {
			console.warn("Posisjon ikke tilgjengelig ‚Äì marker manuelt.");
		});

		// ------------------------------------------------------------
		// TEGNING ‚Äì via egne knapper (ett objekt om gangen)
		// ------------------------------------------------------------
		const drawn = L.featureGroup().addTo(map);

		function startDrawPoint() {
			map.pm.disableDraw();
			map.pm.enableDraw('Marker', { snappable: false });
		}

		function startDrawLine() {
			map.pm.disableDraw();
			map.pm.enableDraw('Line', { snappable: false });
		}

		function clearDraw() {
			drawn.clearLayers();
			document.getElementById('GeoJsonCoordinates').value = '';
			map.pm.disableDraw();
		}

		// ------------------------------------------------------------
		// Begrens polyline til KUN 2 punkter
		// ------------------------------------------------------------
		map.on('pm:drawstart', ({ shape, workingLayer }) => {
			// Vi er kun interessert i linjer (Line = polyline i Geoman)
			if (shape === 'Line') {
				// Hver gang et nytt punkt legges til linjen
				workingLayer.on('pm:vertexadded', () => {
					const pts = workingLayer.getLatLngs();

					// Enkel polyline: pts er en array med LatLng
					// N√•r vi har 2 punkter -> avslutt linja
					if (pts.length >= 2) {

						// Foretrukket m√•te: bruk Geoman sin interne "finish"
						if (map.pm?.Draw?.Line?._finishShape) {
							map.pm.Draw.Line._finishShape();
						} else {
							// Fallback hvis API endres: sl√• av tegning
							map.pm.disableDraw();
						}
					}
				});
			}
		});

		map.on('pm:create', (e) => {
			drawn.clearLayers();
			drawn.addLayer(e.layer);
			map.pm.disableDraw();

			document.getElementById('GeoJsonCoordinates').value =
				JSON.stringify(e.layer.toGeoJSON().geometry);
		});

		// ------------------------------------------------------------
		// KOBLE TIL EGNE KNAPPER (type="button" viktig!)
		// ------------------------------------------------------------
			const btnLocate = document.getElementById("btnLocate");
		const btnPoint = document.getElementById("btnDrawPoint");
		const btnLine = document.getElementById("btnDrawLine");
		const btnClear = document.getElementById("btnClearDraw");

		// Fjern aktiv-stil fra alle tegneknapper
		function resetActiveButtons() {
			btnPoint?.classList.remove("active-map-btn");
			btnLine?.classList.remove("active-map-btn");
		}

		// Aktiver en av knappene
		function setActiveButton(btn) {
			resetActiveButtons();
			btn?.classList.add("active-map-btn");
		}

		// Koble knapper
		btnLocate?.addEventListener("click", () => {
			resetActiveButtons();     // posisjonsknappen skal ikke f√• aktiv-stil
			locateUser();
		});

		btnPoint?.addEventListener("click", () => {
			setActiveButton(btnPoint);
			startDrawPoint();
		});

		btnLine?.addEventListener("click", () => {
			setActiveButton(btnLine);
			startDrawLine();
		});

		if (btnClear) {
			btnClear.addEventListener("click", () => {
				resetActiveButtons();
				clearDraw();
			});
		}

		// Fjern gr√∏nn knapp etter ferdig tegning
		map.on("pm:create", () => {
			resetActiveButtons();
		});


		// ------------------------------------------------------------
		// LOCAL STORAGE ‚Äì utkast (kommentar + geometri)
		// ------------------------------------------------------------
		const formKey = "ObstacleReportForm";

		window.addEventListener("load", () => {
			const notice = document.getElementById("restoreNotice");
			const saved = localStorage.getItem(formKey);
			notice.style.display = "none";
			if (!saved) return;

			let data = null;
			try { data = JSON.parse(saved); }
			catch { localStorage.removeItem(formKey); return; }

			const hasComment = data.comment && data.comment.trim().length > 0;
			const hasGeo = data.geoJson && data.geoJson.trim().length > 0;

			if (!(hasComment || hasGeo)) { localStorage.removeItem(formKey); return; }

			if (hasComment)
				document.querySelector('[name="ObstacleComment"]').value = data.comment;

			if (hasGeo) {
				document.getElementById('GeoJsonCoordinates').value = data.geoJson;
				notice.style.display = "block";

				// Tegn mark√∏r eller linje hvis geojson finnes
				try {
					const geom = JSON.parse(data.geoJson);
					if (geom.type === "Point" && geom.coordinates?.length === 2) {
						const [lng, lat] = geom.coordinates;
						const restoredMarker = L.marker([lat, lng]).addTo(map);
						drawn.clearLayers();
						drawn.addLayer(restoredMarker);
						map.setView([lat, lng], 15);
					} else if (geom.type === "LineString" && Array.isArray(geom.coordinates)) {
						const latlngs = geom.coordinates.map(([lng, lat]) => [lat, lng]);
						const restoredLine = L.polyline(latlngs, { color: "orange", weight: 4 }).addTo(map);
						drawn.clearLayers();
						drawn.addLayer(restoredLine);
						map.fitBounds(restoredLine.getBounds());
					}
				} catch (err) {
					console.warn("Kunne ikke gjenopprette geometri:", err);
				}
			}
		});

		// Autosave hvert 5. sekund
		setInterval(() => {
			const comment = document.querySelector('[name="ObstacleComment"]').value || "";
			const geo = document.getElementById('GeoJsonCoordinates').value || "";
			if (comment.trim() || geo.trim())
				localStorage.setItem(formKey, JSON.stringify({ comment, geoJson: geo }));
			else
				localStorage.removeItem(formKey);
		}, 5000);

		// Fjern ved innsending
		document.querySelector("form").addEventListener("submit", () => localStorage.removeItem(formKey));

		// Manuell t√∏mming av utkast
		document.getElementById("clearDraftBtn").addEventListener("click", () => {
			if (confirm("Er du sikker p√• at du vil slette utkastet?")) {
				localStorage.removeItem(formKey);
				document.querySelector('[name="ObstacleComment"]').value = "";
				document.getElementById('GeoJsonCoordinates').value = "";
				drawn.clearLayers();
				document.getElementById("restoreNotice").style.display = "none";
			}
		});
	</script>
}
