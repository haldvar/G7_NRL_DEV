@model NRL_PROJECT.Models.ObstacleData

@section Styles {
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/@@geoman-io/leaflet-geoman-free@@latest/dist/leaflet-geoman.css" />
}

@{
    ViewBag.HideChrome = true;  // tells layout to hide header/footer
}

<form asp-action="SubmitObstacleWithLocation" asp-controller="Map" method="post" enctype="multipart/form-data">
    @Html.AntiForgeryToken()

    <!-- Hidden file input (triggered by Upload button) -->
    <input asp-for="ImageFile" type="file"
           accept=".jpg,.jpeg,.png,.heic,.webp"
           capture="environment"
           id="imageInput" class="hidden" />
    <!-- Keep this hidden field for GeoJSON -->
    <input type="hidden" asp-for="MapData.GeoJsonCoordinates" id="GeoJsonCoordinates" />

    <div class="min-h-[100svh] w-full p-4 md:p-6 bg-gradient-to-b from-green-100 to-blue-100">
        <div class="relative rounded-3xl border border-white/60 bg-white/40 backdrop-blur overflow-hidden shadow-xl
                    h-[calc(100svh-2rem)] md:h-[calc(100svh-3rem)]">

            <!-- MAP -->
            <div id="mapDraw" class="absolute inset-0 z-0" style="border-radius: inherit;"></div>

            <!-- Top bar (subtle) -->
            <div class="pointer-events-none absolute left-0 right-0 top-0 z-20 px-4 py-3">
                <div class="mx-auto max-w-7xl">
                    <div class="inline-flex items-center gap-3 rounded-full bg-white/80 backdrop-blur px-4 py-2
                                border border-white/70 shadow">
                        <span class="text-sm font-semibold text-green-700">Registrer hinder</span>
                        <span class="hidden text-xs text-gray-500 sm:inline">Marker punkt eller tegn en kort linje</span>
                    </div>
                </div>
            </div>

            <!-- Floating map tools: right side (draw) -->
            <div class="absolute bottom-6 right-4 z-20">
                <div class="flex flex-col items-center gap-4 rounded-[2rem] bg-white/40 backdrop-blur border border-white/60 p-3 shadow-lg">
                    <!-- Draw Point -->
                    <button id="btnDrawPoint" type="button"
                            class="h-24 w-24 md:h-28 md:w-28 rounded-full bg-white/85 backdrop-blur border border-white/70 shadow-lg
                                   hover:shadow-xl active:scale-95 transition inline-flex items-center justify-center"
                            title="Marker punkt">
                        <img src="/icons/map-pin.svg" alt="" class="h-12 w-12 md:h-14 md:w-14 opacity-90 pointer-events-none" />
                    </button>
                    <div class="h-px w-16 md:w-20 bg-white/60"></div>
                    <!-- Draw Line -->
                    <button id="btnDrawLine" type="button"
                            class="h-24 w-24 md:h-28 md:w-28 rounded-full bg-white/85 backdrop-blur border border-white/70 shadow-lg
                                   hover:shadow-xl active:scale-95 transition inline-flex items-center justify-center"
                            title="Tegn linje (2 punkter)">
                        <img src="/icons/line.svg" alt="" class="h-12 w-12 md:h-14 md:w-14 opacity-90 pointer-events-none" />
                    </button>
                </div>
            </div>

            <!-- Floating nav: top-right (home) -->
            <div class="absolute top-6 right-4 z-20">
                <a asp-area="" asp-controller="Home" asp-action="Index"
                   class="h-24 w-24 md:h-28 md:w-28 rounded-full bg-white/85 backdrop-blur border border-white/70 shadow-lg
                          hover:shadow-xl active:scale-95 transition inline-flex items-center justify-center"
                   title="Til forsiden" aria-label="Til forsiden">
                    <img src="/icons/home.svg" alt="" class="h-10 w-10 md:h-12 md:w-12 opacity-90 pointer-events-none" />
                </a>
            </div>

            <!-- Floating tools: left side (Upload + Comment + Locate) -->
            <div class="absolute bottom-6 left-4 z-20">
                <div class="flex flex-col gap-3 rounded-[2rem] bg-white/40 backdrop-blur border border-white/60 p-3 shadow-lg">

                    <!-- Upload Image card -->
                    <button id="btnUploadImage" type="button"
                            class="w-64 md:w-60 rounded-3xl bg-white/90 backdrop-blur border border-white/80 shadow-md
                                   hover:shadow-lg active:scale-[0.98] transition flex items-center px-4 py-3 text-left">
                        <div class="flex items-center justify-center h-12 w-12 rounded-full bg-blue-50">
                            <img src="/icons/kamera.svg" alt="" class="h-6 w-6 opacity-90 pointer-events-none" />
                        </div>
                        <div class="ml-3 flex flex-col">
                            <span class="text-sm font-semibold text-slate-900">Legg til bilde</span>
                            <span class="text-xs text-gray-500">(Frivillig)</span>
                        </div>
                    </button>

                    <!-- Comment card -->
                    <button id="btnComment" type="button"
                            class="w-64 md:w-60 rounded-3xl bg-white/90 backdrop-blur border border-white/80 shadow-md
                                   hover:shadow-lg active:scale-[0.98] transition flex items-center px-4 py-3 text-left">
                        <div class="flex items-center justify-center h-12 w-12 rounded-full bg-green-50">
                            <img src="/icons/kommentar.svg" alt="" class="h-6 w-6 opacity-90 pointer-events-none" />
                        </div>
                        <div class="ml-3 flex flex-col">
                            <span class="text-sm font-semibold text-slate-900">Legg til kommentar</span>
                            <span class="text-xs text-gray-500">(Frivillig)</span>
                        </div>
                    </button>

                    <!-- Locate card -->
                    <button id="btnLocate" type="button"
                            class="w-64 md:w-60 rounded-3xl bg-white/90 backdrop-blur border border-white/80 shadow-md
                                   hover:shadow-lg active:scale-[0.98] transition flex items-center px-4 py-3 text-left">
                        <div class="flex items-center justify-center h-12 w-12 rounded-full bg-amber-50">
                            <img src="/icons/helicopter.svg" alt="" class="h-6 w-6 opacity-90 pointer-events-none" />
                        </div>
                        <div class="ml-3 flex flex-col">
                            <span class="text-sm font-semibold text-slate-900">Finn min posisjon</span>
                            <span class="text-xs text-gray-500">(GPS)</span>
                        </div>
                    </button>

                </div>
            </div>


            <!-- Submit report button (center bottom) -->
            <div class="absolute bottom-6 left-1/2 -translate-x-1/2 z-20">
                <button type="submit" id="submitBtn"
                        class="inline-flex items-center gap-3 rounded-full bg-blue-600 px-11 py-9 
                   text-3xl font-semibold text-white shadow-lg hover:shadow-xl hover:bg-blue-700 
                   active:scale-95 transition-opacity transition-transform duration-300 ease-out
                   opacity-0 translate-y-2 pointer-events-none">
                    <span class="leading-none">Meld hinder</span>
                    <svg xmlns="http://www.w3.org/2000/svg"
                         class="h-6 w-6 md:h-7 md:w-7" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                </button>
            </div>

            <!-- Toasts -->
            <div id="restoreToast"
                 class="pointer-events-none absolute left-1/2 top-4 z-40 -translate-x-1/2 rounded-xl bg-sky-600/95 px-5 py-3
                        text-white shadow-2xl font-semibold tracking-wide backdrop-blur transition-opacity duration-500"
                 style="opacity:0;">
                Utkast gjenopprettet
            </div>
            <div id="cancelToast"
                 class="pointer-events-none absolute left-1/2 top-20 z-40 -translate-x-1/2 rounded-xl bg-sky-600/95 px-5 py-3
                        text-white shadow-2xl font-semibold tracking-wide backdrop-blur transition-opacity duration-500"
                 style="opacity:0;">
                Rapport nullstilt
            </div>
            <!-- Image attached toast -->
            <div id="imageToast"
                 class="pointer-events-none absolute left-1/2 top-36 z-40 -translate-x-1/2 rounded-xl bg-emerald-600/95 px-5 py-3
                        text-white shadow-2xl font-semibold tracking-wide backdrop-blur transition-opacity duration-500"
                 style="opacity:0;">
                Bilde vedlagt
            </div>

            <!-- Error toast (NEW) -->
            <div id="errorToast"
                 class="pointer-events-none absolute left-1/2 top-52 z-40 -translate-x-1/2 rounded-xl bg-rose-600/95 px-5 py-3
                        text-white shadow-2xl font-semibold tracking-wide backdrop-blur transition-opacity duration-500"
                 style="opacity:0;">
                <span id="errorToastText">Feil ved opplasting</span>
            </div>

            <!-- Accuracy toast -->
            <div id="accuracyToast"
                 class="pointer-events-none absolute left-1/2 top-[17rem] z-40 -translate-x-1/2
					rounded-xl bg-orange-500/95 px-6 py-4 text-white shadow-2xl
					font-semibold tracking-wide backdrop-blur transition-opacity duration-300"
                 style="opacity:0;">
                <span id="accuracyToastText">‚ö†Ô∏è Posisjon for un√∏yaktig</span>
                <div id="accuracyToastDetail" class="text-sm opacity-90 mt-1"></div>
            </div>


            <!-- Bottom comment sheet -->
            <div id="commentSheetBackdrop"
                 class="hidden absolute inset-0 z-30 bg-black/20"></div>

            <div id="commentSheet"
                 class="absolute left-0 right-0 bottom-0 z-40 translate-y-full transition-transform duration-300 ease-out">
                <div class="rounded-t-3xl border-t border-slate-200 bg-white/95 backdrop-blur shadow-2xl p-5">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-bold text-green-700">Kommentar</h3>
                        <button type="button" id="closeComment"
                                class="rounded-full p-2 hover:bg-gray-100 active:scale-95 transition" title="Lukk">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>

                    <div class="mt-3">
                        <label asp-for="ObstacleComment" class="block text-sm font-semibold text-gray-700">Kommentar</label>
                        <textarea asp-for="ObstacleComment" rows="4"
                                  class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-gray-900
                                         focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                  placeholder="Valgfritt"></textarea>
                        <span asp-validation-for="ObstacleComment" class="text-red-600 text-sm"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>


@if (!ViewData.ModelState.IsValid)
{
<div class="mx-auto max-w-2xl bg-red-600 text-white p-4 rounded-xl mt-6">
    <ul class="list-disc list-inside">
        @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
        {
        <li>@error.ErrorMessage</li>
        }
    </ul>
</div>
}

@section Scripts {
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@@geoman-io/leaflet-geoman-free@@latest/dist/leaflet-geoman.min.js"></script>

<script>

    function showAccuracyToast(accuracyMeters) {
        const toast = document.getElementById("accuracyToast");
        const detail = document.getElementById("accuracyToastDetail");

        if (!toast) return;

        detail.textContent = `N√∏yaktighet: ¬±${Math.round(accuracyMeters)} m`;

        toast.style.opacity = "1";
        setTimeout(() => {
            toast.style.opacity = "0";
        }, 4000);
    }

    let restoredFromDraft = false;

    // -------------------------------------------
    //  IKON
    // -------------------------------------------
    const helicopterIcon = L.icon({
        iconUrl: '/icons/helicopter.svg',
        iconSize: [45, 45],
        iconAnchor: [19, 19],
        popupAnchor: [0, -12]
    });

    // -------------------------------------------
    //  MAP SETUP
    // -------------------------------------------
    const map = L.map('mapDraw', {
        zoomControl: false,
        touchZoom: true,
        scrollWheelZoom: true,
        doubleClickZoom: true,
        boxZoom: false
    }).setView([58.333, 8.233], 5);   // fallback 

    // Autolocate if no draft is restored
    if (!restoredFromDraft) {
        map.locate({
            setView: true,        // Leaflet zoomer f√∏rste gang (ikke ved knappen)
            maxZoom: 19,
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        });
    }

    // -------------------------------------------
    //  TILELAYER
    // -------------------------------------------
    L.tileLayer.wms('https://wms.geonorge.no/skwms1/wms.topo', {
        layers: 'topo',
        format: 'image/png',
        transparent: false,
        attribution: '¬© Kartverket'
    }).addTo(map);

    // Remove Geoman toolbars
    map.pm.addControls({ drawMarker: false, drawPolyline: false, editMode: false, removalMode: false });
    if (map.pm?.Toolbar) map.pm.Toolbar.removeControls();

    setTimeout(() => map.invalidateSize(), 300);

    const drawn = L.featureGroup().addTo(map);

    // -------------------------------------------
    //  POSISTION
    // -------------------------------------------

    function locateUser() {
        map.locate({
            setView: false,
            maxZoom: 19,
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        });
    }

    map.on("locationfound", (e) => {
        // Fjern tidligere posisjon
        if (window.currentPosMarker) map.removeLayer(window.currentPosMarker);
        if (window.currentPosCircle) map.removeLayer(window.currentPosCircle);

        // Un√∏yaktig posisjon
        if (e.accuracy > 200) {
            // Vis toast
            showAccuracyToast(e.accuracy);
            map.setView(e.latlng, 8);
            return;
        }

        map.setView(e.latlng, 18);

        window.currentPosMarker = L.marker(e.latlng, { icon: helicopterIcon })
            .addTo(map)
            .bindPopup(`
				<div class="popup-heading">üöÅ Helikopterposisjon</div>
				<div class="popup-accuracy">N√∏yaktighet: ¬±${Math.round(e.accuracy)} m</div>
			`)
            .openPopup();

        setTimeout(() => {
            if (window.currentPosMarker) window.currentPosMarker.closePopup();
        }, 3000);

        // Heading 
        if (typeof e.heading === "number" && !isNaN(e.heading)) {
            window.currentPosMarker.setRotationAngle(e.heading);
        }

        // Accuracy circle
        window.currentPosCircle = L.circle(e.latlng, {
            radius: Math.min(e.accuracy / 2, 100),
            color: "blue",
            weight: 2,
            opacity: 0.6,
            fillOpacity: 0.15
        }).addTo(map);
    });

    map.on("locationerror", () => {
        console.warn("Posisjon ikke tilgjengelig ‚Äì bruker fallback.");
    });

    // Helikopter-knapp
    document.getElementById("btnLocate")?.addEventListener("click", () => {
        resetActiveButtons();
        locateUser();
    });

    // -------------------------------------------
    //  DRAWING
    // -------------------------------------------
    const btnPoint = document.getElementById("btnDrawPoint");
    const btnLine = document.getElementById("btnDrawLine");

    function resetActiveButtons() {
        [btnPoint, btnLine].forEach(btn => {
            btn?.classList.remove("ring-4", "ring-green-400", "scale-95", "bg-green-50");
        });
    }

    function setActiveButton(btn) {
        resetActiveButtons();
        btn?.classList.add("ring-4", "ring-green-400", "scale-95", "bg-green-50");
    }

    btnPoint?.addEventListener("click", () => {
        setActiveButton(btnPoint);
        map.pm.disableDraw();
        map.pm.enableDraw('Marker', { snappable: false });
    });

    btnLine?.addEventListener("click", () => {
        setActiveButton(btnLine);
        map.pm.disableDraw();
        map.pm.enableDraw('Line', { snappable: false });
    });

    // Line limit: 2 points
    map.on('pm:drawstart', ({ shape, workingLayer }) => {
        if (shape === 'Line') {
            workingLayer.on('pm:vertexadded', () => {
                const pts = workingLayer.getLatLngs();
                if (pts.length >= 2) {
                    if (map.pm?.Draw?.Line?._finishShape)
                        map.pm.Draw.Line._finishShape();
                    else
                        map.pm.disableDraw();
                }
            });
        }
    });

    // Only one geometry total
    map.on('pm:create', (e) => {
        drawn.clearLayers();
        drawn.addLayer(e.layer);
        map.pm.disableDraw();

        document.getElementById('GeoJsonCoordinates').value =
            JSON.stringify(e.layer.toGeoJSON().geometry);

        resetActiveButtons();
        saveDraft();
        updateSubmitVisibility();
    });

    // -------------------------------------------
    //  UPLOAD IMAGE (with validation) - UPDATED
    // -------------------------------------------
    const imgInput = document.getElementById('imageInput');
    const btnUpload = document.getElementById('btnUploadImage');
    const imageToast = document.getElementById('imageToast');
    const errorToast = document.getElementById('errorToast');
    const errorText = document.getElementById('errorToastText');

    btnUpload?.addEventListener('click', () => imgInput?.click());

    imgInput?.addEventListener('change', (e) => {
        const file = e.target.files?.[0];
        if (!file) return;

        // Client-side validation
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/heic', 'image/webp'];
        const allowedExtensions = ['.jpg', '.jpeg', '.png', '.heic', '.webp'];
        const maxSize = 5 * 1024 * 1024; // 5MB

        // Get file extension
        const fileName = file.name.toLowerCase();
        const hasValidExtension = allowedExtensions.some(ext => fileName.endsWith(ext));

        // Check MIME type AND extension (double validation)
        if (!allowedTypes.includes(file.type) && !hasValidExtension) {
            errorText.textContent = 'Kun .jpg, .jpeg, .png, .heic, .webp er tillatt';
            errorToast.style.opacity = "1";
            setTimeout(() => errorToast.style.opacity = "0", 5000);
            e.target.value = ''; // Clear the invalid file
            return;
        }

        if (file.size > maxSize) {
            errorText.textContent = 'Bildet m√• v√¶re mindre enn 5MB';
            errorToast.style.opacity = "1";
            setTimeout(() => errorToast.style.opacity = "0", 5000);
            e.target.value = ''; // Clear the invalid file
            return;
        }

        // Success - show confirmation toast
        imageToast.style.opacity = "1";
        setTimeout(() => imageToast.style.opacity = "0", 3500);
        saveDraft();
    });

    // ------ Comment bottom sheet ------
    const btnComment = document.getElementById('btnComment');
    const sheet = document.getElementById('commentSheet');
    const backdrop = document.getElementById('commentSheetBackdrop');
    const closeComment = document.getElementById('closeComment');

    function openSheet(){
        sheet.classList.remove('translate-y-full');
        backdrop.classList.remove('hidden');
        setTimeout(() => map.invalidateSize(), 200);
    }
    function closeSheet(){
        sheet.classList.add('translate-y-full');
        backdrop.classList.add('hidden');
        setTimeout(() => map.invalidateSize(), 200);
    }
    btnComment?.addEventListener('click', openSheet);
    closeComment?.addEventListener('click', closeSheet);
    backdrop?.addEventListener('click', closeSheet);

    // -------------------------------------------
    //  AUTOSAVE
    // -------------------------------------------
    const formKey = "ObstacleReportForm";
    let draftDisabled = false;

    function saveDraft() {
        if (draftDisabled) return;

        const commentInput = document.querySelector('[name="ObstacleComment"]');
        const comment = commentInput ? (commentInput.value || "") : "";
        const geo = document.getElementById('GeoJsonCoordinates').value || "";

        if (geo.trim().length > 0) {
            localStorage.setItem(formKey, JSON.stringify({ comment, geoJson: geo }));
        } else {
            localStorage.removeItem(formKey);
        }
    }

    // -------------------------------------------
    //  HIDE AND SHOW SUBMIT BUTTON JS
    // -------------------------------------------

    const commentField = document.querySelector('[name="ObstacleComment"]');
    commentField?.addEventListener("input", saveDraft);

    const submitBtn = document.getElementById("submitBtn");
    const geoInput = document.getElementById("GeoJsonCoordinates");

    function updateSubmitVisibility() {
        if (!submitBtn || !geoInput) return;

        const hasGeom = (geoInput.value || "").trim().length > 0;

        if (hasGeom) {
            // fade/slide in
            submitBtn.classList.remove("opacity-0", "pointer-events-none", "translate-y-2");
            submitBtn.classList.add("opacity-100", "translate-y-0");
        } else {
            // hide again
            submitBtn.classList.add("opacity-0", "pointer-events-none", "translate-y-2");
            submitBtn.classList.remove("opacity-100", "translate-y-0");
        }
    }

    window.addEventListener("load", () => {
        updateSubmitVisibility();
    });

    // -------------------------------------------
    //  RESTORE DRAFT
    // -------------------------------------------
    window.addEventListener("load", () => {
        const saved = localStorage.getItem(formKey);
        if (!saved) return;

        let data;
        try {
            data = JSON.parse(saved);
        } catch {
            localStorage.removeItem(formKey);
            return;
        }

        if (!data.geoJson) return;

        document.getElementById('GeoJsonCoordinates').value = data.geoJson;
        if (data.comment && commentField) commentField.value = data.comment;

        const geom = JSON.parse(data.geoJson);
        drawn.clearLayers();

        if (geom.type === "Point") {
            const [lng, lat] = geom.coordinates;
            const m = L.marker([lat, lng]).addTo(map);
            drawn.addLayer(m);
            map.setView([lat, lng], 19);
        } else if (geom.type === "LineString") {
            const latlngs = geom.coordinates.map(([lng, lat]) => [lat, lng]);
            const l = L.polyline(latlngs, { color: "orange", weight: 4 }).addTo(map);
            drawn.addLayer(l);
            map.fitBounds(l.getBounds());
            setTimeout(() => map.setZoom(19), 150);
        }

        restoredFromDraft = true;

        const toast = document.getElementById("restoreToast");
        if (toast) {
            toast.style.opacity = "1";
            setTimeout(() => { toast.style.opacity = "0"; }, 5000);
        }

        updateSubmitVisibility();
    });

    // -------------------------------------------
    //  SUBMIT
    // -------------------------------------------
    document.getElementById("submitBtn")?.addEventListener("click", () => {
        draftDisabled = true;
        localStorage.removeItem(formKey);
    });

    // -------------------------------------------
    //  CANCEL
    // -------------------------------------------
    const cancelBtn = document.getElementById('cancelBtn');
    function showCancelToast() {
        const t = document.getElementById("cancelToast");
        if (!t) return;
        t.style.opacity = "1";
        setTimeout(() => t.style.opacity = "0", 5000);
    }

    cancelBtn?.addEventListener('click', () => {
        draftDisabled = true;
        localStorage.removeItem(formKey);
        if (commentField) commentField.value = "";
        document.getElementById('GeoJsonCoordinates').value = "";
        drawn.clearLayers();
        map.pm.disableDraw();
        resetActiveButtons();
        if (window.currentPosMarker){
            map.removeLayer(window.currentPosMarker);
            window.currentPosMarker=null;
        }
        if (window.currentPosCircle){
            map.removeLayer(window.currentPosCircle);
            window.currentPosCircle=null;
        }
        showCancelToast();
    });

</script>
}
