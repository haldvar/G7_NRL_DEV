@model NRL_PROJECT.Models.ObstacleData

@section Styles {
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
	<link rel="stylesheet" href="https://unpkg.com/@@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css" />

	<style>
		/* Store, runde kartknapper */
		.map-btn-norge {
			width: 120px;
			height: 120px;
			background-color: rgba(255, 255, 255, 0.85);
			border: none;
			border-radius: 50%;
			backdrop-filter: blur(6px);
			box-shadow: 0 4px 12px rgba(0,0,0,0.30);
			display: flex;
			align-items: center;
			justify-content: center;
			transition: transform 0.15s ease, box-shadow 0.2s ease;
		}

			.map-btn-norge img {
				width: 90px;
				height: 90px;
				pointer-events: none;
				opacity: 0.95;
			}

			.map-btn-norge:active {
				transform: scale(0.92);
				background-color: rgba(0, 200, 100, 0.9);
				box-shadow: 0 0 20px rgba(0, 200, 100, 0.6);
			}

		.active-map-btn {
			background-color: rgba(0, 200, 100, 0.9) !important;
			box-shadow: 0 0 25px rgba(0, 200, 100, 0.6) !important;
			transform: scale(1.05);
			transition: all 0.2s ease;
		}

		/* Popup-stil */
		.leaflet-popup-content-wrapper {
			padding: 20px 26px;
			font-size: 1.2rem;
			line-height: 1.4;
		}

		.leaflet-popup-content-wrapper,
		.leaflet-popup-tip {
			background: white;
			border-radius: 14px;
			box-shadow: 0 4px 20px rgba(0,0,0,0.3);
		}

		.popup-heading {
			font-size: 1.4rem;
			font-weight: 700;
			margin-bottom: 8px;
		}

		.popup-accuracy {
			font-size: 1.2rem;
			opacity: 0.8;
		}
	</style>
}

<div class="text-center mb-10">
	<h1 class="text-4xl md:text-5xl font-extrabold text-sky-400 tracking-tight"> Registrer hinder</h1>
	<p class="text-slate-300 mt-3 text-lg">Fyll inn rapportdetaljer, legg til et bilde og marker posisjon p√• kartet.</p>
</div>

<form asp-action="SubmitObstacleWithLocation" asp-controller="Map" method="post" enctype="multipart/form-data" class="space-y-10">
	@Html.AntiForgeryToken()

	<!-- OBSTACLE / MAP-CONTAINER -->
	<div class="bg-slate-700/60 rounded-2xl p-8 shadow-lg border border-slate-600">
		<h2 class="text-2xl font-bold text-sky-300 mb-6"> Informasjon om hinderet</h2>

		<!-- MAP SECTION -->
		<div class="bg-slate-700/60 rounded-2xl p-8 shadow-lg border border-slate-600">
			<h2 class="text-2xl md:text-3xl font-bold text-amber-400 mb-4 text-center">üó∫Ô∏è Marker hinderposisjon</h2>
			<p class="text-center text-slate-300 mb-6 text-lg">Bruk helikopterknappen for √• finne din posisjon.</p>

			<div id="mapWrapper" class="relative rounded-xl overflow-hidden" style="height: 400px;">

				<!-- Toast for gjenopprettet utkast -->
				<div id="restoreToast"
					 class="absolute top-4 left-1/2 -translate-x-1/2
                            bg-sky-500/95 text-white text-xl px-6 py-3
                            rounded-xl shadow-2xl font-bold tracking-wide
                            backdrop-blur-sm z-[99999]
                            transition-opacity duration-500"
					 style="opacity:0; pointer-events:none;">
					Utkast gjenopprettet
				</div>

				<!-- Toast for cancel/nullstilling -->
				<div id="cancelToast"
					 class="absolute top-20 left-1/2 -translate-x-1/2
                        bg-sky-600/95 text-white text-xl px-6 py-3
                        rounded-xl shadow-2xl font-bold tracking-wide
                        backdrop-blur-sm z-[99999]
                        transition-opacity duration-500"
					 style="opacity:0; pointer-events:none;">
					Rapport nullstilt
				</div>

				<!-- Leaflet map -->
				<div id="mapDraw" class="absolute inset-0 z-0"></div>

				<!-- H√∏yre knappestack (punkt / linje) -->
				<div class="absolute bottom-6 right-4 flex flex-col gap-3 z-[9999]">
					<button id="btnDrawPoint" type="button" class="map-btn-norge" aria-label="Marker punkt">
						<img src="/icons/map-pin.svg" alt="Marker hinder" />
					</button>

					<button id="btnDrawLine" type="button" class="map-btn-norge" aria-label="Tegn linje">
						<img src="/icons/line.svg" alt="Tegn linje" />
					</button>
				</div>

				<!-- Venstre knapp (min posisjon) -->
				<div class="absolute bottom-6 left-4 z-[9999]">
					<button id="btnLocate" type="button" class="map-btn-norge" aria-label="Finn min posisjon">
						<img src="/icons/helicopter.svg" alt="Finn posisjon" />
					</button>
				</div>

			</div>
		</div>

		<!-- Kommentar + bilde -->
		<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
			<div>
				<label asp-for="ObstacleComment" class="block text-sm font-medium text-sky-200">Kommentar</label>
				<textarea asp-for="ObstacleComment" rows="3"
						  class="mt-1 block w-full bg-slate-900 border-slate-600 text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-sky-400 focus:outline-none"></textarea>
				<span asp-validation-for="ObstacleComment" class="text-red-500 text-sm"></span>
			</div>

			<div>
				<label asp-for="ImageFile" class="block text-sm font-medium text-sky-200">Last opp bilde</label>
				<input asp-for="ImageFile"
					   type="file"
					   accept="image/*"
					   capture="environment"
					   class="mt-1 block w-full bg-slate-900 border-slate-600 text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-sky-400 focus:outline-none" />
				<span asp-validation-for="ImageFile" class="text-red-500 text-sm"></span>
			</div>
		</div>

		<!-- Hidden map field -->
		<input type="hidden" asp-for="MapData.GeoJsonCoordinates" id="GeoJsonCoordinates" />
	</div>

	<!-- SUBMIT / CANCEL -->
	<div class="flex flex-col md:flex-row justify-center gap-6 mt-10">
		<button type="submit"
				id="submitBtn"
				class="bg-emerald-600 hover:bg-emerald-700 text-white px-10 py-4 rounded-2xl font-bold text-xl shadow-lg hover:shadow-2xl transform hover:-translate-y-1 transition-all">
			Submit Report
		</button>

		<button type="button"
				id="cancelBtn"
				class="bg-red-600 hover:bg-red-700 text-white px-10 py-4 rounded-2xl font-bold text-xl shadow-lg hover:shadow-2xl transform hover:-translate-y-1 transition-all">
			Cancel
		</button>
	</div>
</form>

@if (!ViewData.ModelState.IsValid)
{
	<div class="bg-red-600 text-white p-4 rounded-lg mt-6">
		<ul class="list-disc list-inside">
			@foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
			{
				<li>@error.ErrorMessage</li>
			}
		</ul>
	</div>
}

@section Scripts {
	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
	<script src="https://unpkg.com/@@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"></script>
	<script src="https://rawcdn.githack.com/bbecquet/Leaflet.RotatedMarker/master/leaflet.rotatedMarker.js"></script>

	<script>
		// ------------------------------------------------------------
		// IKON / KARTINIT
		// ------------------------------------------------------------
		const helicopterIcon = L.icon({
			iconUrl: '/icons/helicopter.svg',
			iconSize: [45, 45],
			iconAnchor: [19, 19],
			popupAnchor: [0, -12]
		});

		// fallback
		const map = L.map('mapDraw', {
			zoomControl: false,
			touchZoom: true,
			scrollWheelZoom: true,
			doubleClickZoom: true,
			boxZoom: false
		}).setView([58.333, 8.233], 13); // fallback-omr√•de

		map.locate({
			setView: true,
			maxZoom: 18,
			enableHighAccuracy: true,
			timeout: 10000,
			maximumAge: 0
		});

		L.tileLayer.wms('https://wms.geonorge.no/skwms1/wms.topo', {
			layers: 'topo',
			format: 'image/png',
			transparent: false,
			attribution: '¬© Kartverket'
		}).addTo(map);

		// Vi bruker egne knapper ‚Äì sl√• av standard Geoman-knapper
		map.pm.addControls({ drawMarker: false, drawPolyline: false, editMode: false, removalMode: false });
		if (map.pm?.Toolbar) map.pm.Toolbar.removeControls();

		setTimeout(() => map.invalidateSize(), 300);

		// Layergruppe for brukerens geometri (punkt eller linje)
		const drawn = L.featureGroup().addTo(map);

		// ------------------------------------------------------------
		// POSISJON
		// ------------------------------------------------------------
		function locateUser() {
			map.locate({
				setView: true,
				maxZoom: 18,
				enableHighAccuracy: true,
				timeout: 10000,
				maximumAge: 0
			});
		}

		map.on("locationfound", (e) => {
			if (window.currentPosMarker) map.removeLayer(window.currentPosMarker);
			if (window.currentPosCircle) map.removeLayer(window.currentPosCircle);

			// N√∏yaktighetssjekk 
			if (e.accuracy > 200) {
				const popup = L.popup({ closeButton: false, autoPan: true })
					.setLatLng(e.latlng)
					.setContent(`
						<div class="popup-heading">‚ö†Ô∏è Posisjon for upresis</div>
						<div class="popup-accuracy">N√∏yaktighet: ¬±${Math.round(e.accuracy)} m</div>
					`)
					.openOn(map);

				setTimeout(() => map.closePopup(popup), 3000);
				return;
			}

			// Helikopter-mark√∏r
			window.currentPosMarker = L.marker(e.latlng, { icon: helicopterIcon })
				.addTo(map)
				.bindPopup(`
					<div class="popup-heading">üöÅ Helikopterposisjon</div>
					<div class="popup-accuracy">N√∏yaktighet: ¬±${Math.round(e.accuracy)} m</div>
				`)
				.openPopup();

			// Lukk popup etter 3 sekunder
			setTimeout(() => {
				if (window.currentPosMarker) {
					window.currentPosMarker.closePopup();
				}
			}, 3000);

			// Rot√©r helikopter basert p√• heading hvis tilgjengelig
			if (typeof e.heading === "number" && !isNaN(e.heading)) {
				window.currentPosMarker.setRotationAngle(e.heading);
			}

			// N√∏yaktighetssirkel
			window.currentPosCircle = L.circle(e.latlng, {
				radius: Math.min(e.accuracy / 2, 100),
				color: "blue",
				weight: 2,
				opacity: 0.6,
				fillOpacity: 0.15
			}).addTo(map);
		});

		map.on("locationerror", () => {
			console.warn("Posisjon ikke tilgjengelig ‚Äì marker manuelt.");
		});

		const btnLocate = document.getElementById("btnLocate");
		btnLocate?.addEventListener("click", () => {
			resetActiveButtons();
			locateUser();
		});

		// ------------------------------------------------------------
		// TEGNING (√©n geometri totalt)
		// ------------------------------------------------------------
		const btnPoint = document.getElementById("btnDrawPoint");
		const btnLine = document.getElementById("btnDrawLine");

		function resetActiveButtons() {
			btnPoint?.classList.remove("active-map-btn");
			btnLine?.classList.remove("active-map-btn");
		}

		function setActiveButton(btn) {
			resetActiveButtons();
			btn?.classList.add("active-map-btn");
		}

		function startDrawPoint() {
			map.pm.disableDraw();
			map.pm.enableDraw('Marker', { snappable: false });
		}

		function startDrawLine() {
			map.pm.disableDraw();
			map.pm.enableDraw('Line', { snappable: false });
		}

		btnPoint?.addEventListener("click", () => {
			setActiveButton(btnPoint);
			startDrawPoint();
		});

		btnLine?.addEventListener("click", () => {
			setActiveButton(btnLine);
			startDrawLine();
		});

		// Begrens linje til 2 punkter 
		map.on('pm:drawstart', ({ shape, workingLayer }) => {
			if (shape === 'Line') {
				workingLayer.on('pm:vertexadded', () => {
					const pts = workingLayer.getLatLngs();
					if (pts.length >= 2) {
						if (map.pm?.Draw?.Line?._finishShape) {
							map.pm.Draw.Line._finishShape();
						} else {
							map.pm.disableDraw();
						}
					}
				});
			}
		});

		// Kun √©n geometri totalt: enten punkt ELLER linje
		map.on('pm:create', (e) => {
			drawn.clearLayers();
			drawn.addLayer(e.layer);
			map.pm.disableDraw();

			document.getElementById('GeoJsonCoordinates').value =
				JSON.stringify(e.layer.toGeoJSON().geometry);

			resetActiveButtons();
			saveDraft();
		});

		// ------------------------------------------------------------
		// SMART AUTOSAVE 
		// ------------------------------------------------------------
		const formKey = "ObstacleReportForm";
		let draftDisabled = false;

		function saveDraft() {
			if (draftDisabled) return;

			const commentInput = document.querySelector('[name="ObstacleComment"]');
			const comment = commentInput ? (commentInput.value || "") : "";
			const geo = document.getElementById('GeoJsonCoordinates').value || "";

			// Lagre kun hvis vi har geometri ‚Äì hindrer tomme utkast
			if (geo.trim().length > 0) {
				localStorage.setItem(formKey, JSON.stringify({ comment, geoJson: geo }));
			} else {
				localStorage.removeItem(formKey);
			}
		}

		const commentField = document.querySelector('[name="ObstacleComment"]');
		if (commentField) {
			commentField.addEventListener("input", saveDraft);
		}

		// ------------------------------------------------------------
		// GJENOPPRETT UTKAST 
		// ------------------------------------------------------------
		window.addEventListener("load", () => {
			const saved = localStorage.getItem(formKey);
			if (!saved) return;

			let data = null;
			try {
				data = JSON.parse(saved);
			} catch {
				localStorage.removeItem(formKey);
				return;
			}

			const hasComment = data.comment && data.comment.trim().length > 0;
			const hasGeo = data.geoJson && data.geoJson.trim().length > 0;

			if (!hasGeo) {
				localStorage.removeItem(formKey);
				return;
			}

			if (hasComment && commentField) {
				commentField.value = data.comment;
			}

			document.getElementById('GeoJsonCoordinates').value = data.geoJson;

			try {
				const geom = JSON.parse(data.geoJson);
				drawn.clearLayers();

				if (geom.type === "Point" && Array.isArray(geom.coordinates)) {
					const [lng, lat] = geom.coordinates;
					const m = L.marker([lat, lng]).addTo(map);
					drawn.addLayer(m);
					map.setView([lat, lng], 15);
				} else if (geom.type === "LineString" && Array.isArray(geom.coordinates)) {
					const latlngs = geom.coordinates.map(([lng, lat]) => [lat, lng]);
					const l = L.polyline(latlngs, { color: "orange", weight: 4 }).addTo(map);
					drawn.addLayer(l);
					map.fitBounds(l.getBounds());
				}
			} catch (err) {
				console.warn("Kunne ikke gjenopprette geometri:", err);
			}

			// Vis bl√• toast i 5 sek
			const toast = document.getElementById("restoreToast");
			if (toast) {
				toast.style.opacity = "1";
				setTimeout(() => {
					toast.style.opacity = "0";
				}, 5000);
			}
		});

		// ------------------------------------------------------------
		// SLETT UTKAST VED SUBMIT 
		// ------------------------------------------------------------
		const submitBtn = document.getElementById("submitBtn");
		if (submitBtn) {
			submitBtn.addEventListener("click", () => {
				draftDisabled = true;
				localStorage.removeItem(formKey);
			});
		}

		// ------------------------------------------------------------
		// CANCEL ‚Äì nullstill rapport og utkast, ingen redirect
		// ------------------------------------------------------------
		const cancelBtn = document.getElementById("cancelBtn");

		function showCancelToast() {
			const toast = document.getElementById("cancelToast");
			if (!toast) return;

			toast.style.opacity = "1";
			setTimeout(() => {
				toast.style.opacity = "0";
			}, 5000);
		}

		if (cancelBtn) {
			cancelBtn.addEventListener("click", () => {
				// Stopp videre autosave
				draftDisabled = true;

				// Slett utkast
				localStorage.removeItem(formKey);

				// T√∏m felter
				if (commentField) commentField.value = "";
				document.getElementById('GeoJsonCoordinates').value = "";

				// T√∏m kart-geometri
				drawn.clearLayers();

				// Sl√• av tegning og reset knapper
				map.pm.disableDraw();
				resetActiveButtons();

				// (Valgfritt) Fjern posisjonsmark√∏r og sirkel
				if (window.currentPosMarker) {
					map.removeLayer(window.currentPosMarker);
					window.currentPosMarker = null;
				}
				if (window.currentPosCircle) {
					map.removeLayer(window.currentPosCircle);
					window.currentPosCircle = null;
				}

				// Vis toast
				showCancelToast();
			});
		}
	</script>
}
