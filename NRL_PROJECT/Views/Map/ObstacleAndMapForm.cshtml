@model NRL_PROJECT.Models.ObstacleData

@section Styles {
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/@@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css" />
}

@{
    ViewBag.HideChrome = true;  // tells layout to hide header/footer
}

<form asp-action="SubmitObstacleWithLocation" asp-controller="Map" method="post" enctype="multipart/form-data">
    @Html.AntiForgeryToken()

    <!-- Fullscreen map shell with small padding -->
    <div class="min-h-[100svh] w-full p-4 md:p-6 bg-gradient-to-b from-green-100 to-blue-100">
        <div class="relative rounded-3xl border border-white/60 bg-white/40 backdrop-blur overflow-hidden shadow-xl
                h-[calc(100svh-2rem)] md:h-[calc(100svh-3rem)]">

            <!-- MAP -->
            <div id="mapDraw" class="absolute inset-0 z-0"></div>

            <!-- Top bar (subtle) -->
            <div class="pointer-events-none absolute left-0 right-0 top-0 z-20 px-4 py-3">
                <div class="mx-auto max-w-7xl">
                    <div class="inline-flex items-center gap-3 rounded-full bg-white/80 backdrop-blur px-4 py-2
                            border border-white/70 shadow">
                        <span class="text-sm font-semibold text-green-700">✈️ NRL — Registrer hinder</span>
                        <span class="hidden text-xs text-gray-500 sm:inline">Marker punkt eller tegn en kort linje</span>
                    </div>
                </div>
            </div>

            <!-- Floating map tools: right side -->
            <div class="absolute bottom-6 right-4 z-20 flex flex-col gap-3">
                <button id="btnDrawPoint" type="button"
                        class="h-16 w-16 md:h-20 md:w-20 rounded-full bg-white/85 backdrop-blur border border-white/70 shadow-lg
                           hover:shadow-xl active:scale-95 transition inline-flex items-center justify-center"
                        title="Marker punkt">
                    <img src="/icons/map-pin.svg" alt="" class="h-9 w-9 opacity-90 pointer-events-none" />
                </button>

                <button id="btnDrawLine" type="button"
                        class="h-16 w-16 md:h-20 md:w-20 rounded-full bg-white/85 backdrop-blur border border-white/70 shadow-lg
                           hover:shadow-xl active:scale-95 transition inline-flex items-center justify-center"
                        title="Tegn linje (2 punkter)">
                    <img src="/icons/line.svg" alt="" class="h-9 w-9 opacity-90 pointer-events-none" />
                </button>
            </div>
            
            <!-- Floating nav: top-right -->
            <div class="absolute top-6 right-4 z-20 flex flex-col gap-3">
                <a asp-area=""
                   asp-controller="Home"
                   asp-action="Index"
                   class="h-16 w-16 md:h-20 md:w-20 rounded-full bg-white/85 backdrop-blur border border-white/70 shadow-lg
            hover:shadow-xl active:scale-95 transition inline-flex items-center justify-center"
                   title="Til forsiden"
                   aria-label="Til forsiden">
                    <!-- use your existing icon or a home icon -->
                    <img src="/icons/home.svg" alt="" class="h-9 w-9 opacity-90 pointer-events-none" />
                </a>
            </div>

            <!-- Floating: locate (left) -->
            <div class="absolute bottom-6 left-4 z-20">
                <button id="btnLocate" type="button"
                        class="h-16 w-16 md:h-20 md:w-20 rounded-full bg-white/85 backdrop-blur border border-white/70 shadow-lg
                           hover:shadow-xl active:scale-95 transition inline-flex items-center justify-center"
                        title="Finn min posisjon">
                    <img src="/icons/helicopter.svg" alt="" class="h-9 w-9 opacity-90 pointer-events-none" />
                </button>
            </div>

            <!-- Open details panel button (bottom center) -->
            <div class="absolute bottom-6 left-1/2 -translate-x-1/2 z-20">
                <button type="button" id="openPanelBtn"
                        class="inline-flex items-center gap-2 rounded-full bg-gradient-to-r from-green-600 to-blue-600
                           px-6 py-3 text-white font-semibold shadow-lg hover:shadow-xl active:scale-95 transition">
                    Detaljer & bilde
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                </button>
            </div>

            <!-- Slide-over details panel -->
            <aside id="detailsPanel"
                   class="absolute right-0 top-0 z-30 h-full w-full sm:w-[420px] translate-x-full will-change-transform
                      bg-white/95 backdrop-blur border-l border-gray-200 shadow-2xl transition-transform duration-300 ease-out
                      flex flex-col">
                <!-- Panel header -->
                <div class="flex items-center justify-between px-5 py-4 border-b">
                    <h2 class="text-lg font-bold text-green-700">Rapportdetaljer</h2>
                    <button type="button" id="closePanelBtn"
                            class="rounded-full p-2 hover:bg-gray-100 active:scale-95 transition"
                            title="Lukk">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <!-- Panel body -->
                <div class="flex-1 overflow-y-auto px-5 py-5 space-y-6">
                    <!-- Info hint -->
                    <div class="rounded-xl border border-blue-100 bg-blue-50 px-4 py-3 text-sm text-blue-800">
                        Marker posisjon i kartet. Legg til kommentar og last opp et bilde før innsending.
                    </div>

                    <!-- Comment -->
                    <div>
                        <label asp-for="ObstacleComment" class="block text-sm font-semibold text-gray-700">Kommentar</label>
                        <textarea asp-for="ObstacleComment" rows="4"
                                  class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-gray-900
                                     focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                  placeholder="Valgfritt"></textarea>
                        <span asp-validation-for="ObstacleComment" class="text-red-600 text-sm"></span>
                    </div>

                    <!-- Image upload with live preview -->
                    <div>
                        <label asp-for="ImageFile" class="block text-sm font-semibold text-gray-700">Last opp bilde</label>
                        <input asp-for="ImageFile" type="file" accept="image/*" capture="environment"
                               class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-gray-900
                                  focus:ring-2 focus:ring-blue-500 focus:outline-none" />
                        <span asp-validation-for="ImageFile" class="text-red-600 text-sm"></span>

                        <div id="imgPreviewWrap" class="mt-3 hidden">
                            <img id="imgPreview"
                                 class="h-40 w-full rounded-xl border object-cover shadow"
                                 alt="Forhåndsvisning" />
                        </div>
                    </div>

                    <!-- Hidden GeoJSON field -->
                    <input type="hidden" asp-for="MapData.GeoJsonCoordinates" id="GeoJsonCoordinates" />
                </div>

                <!-- Panel footer (actions) -->
                <div class="border-t px-5 py-4">
                    <div class="flex flex-col gap-3 sm:flex-row sm:justify-between">
                        <button type="button" id="cancelBtn"
                                class="rounded-full bg-red-600 px-6 py-3 font-semibold text-white shadow hover:bg-red-700 transition">
                            Nullstill
                        </button>
                        <button type="submit" id="submitBtn"
                                class="rounded-full bg-blue-600 px-6 py-3 font-semibold text-white shadow hover:bg-blue-700 transition">
                            Send inn rapport
                        </button>
                    </div>
                </div>
            </aside>

            <!-- Toasts -->
            <div id="restoreToast"
                 class="pointer-events-none absolute left-1/2 top-4 z-40 -translate-x-1/2 rounded-xl bg-sky-600/95 px-5 py-3
                    text-white shadow-2xl font-semibold tracking-wide backdrop-blur transition-opacity duration-500"
                 style="opacity:0;">
                Utkast gjenopprettet
            </div>
            <div id="cancelToast"
                 class="pointer-events-none absolute left-1/2 top-20 z-40 -translate-x-1/2 rounded-xl bg-sky-600/95 px-5 py-3
                    text-white shadow-2xl font-semibold tracking-wide backdrop-blur transition-opacity duration-500"
                 style="opacity:0;">
                Rapport nullstilt
            </div>
        </div>
    </div>
</form>

@if (!ViewData.ModelState.IsValid)
{
<div class="mx-auto max-w-2xl bg-red-600 text-white p-4 rounded-xl mt-6">
    <ul class="list-disc list-inside">
        @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
        {
        <li>@error.ErrorMessage</li>
        }
    </ul>
</div>
}

@section Scripts {
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"></script>
<script src="https://rawcdn.githack.com/bbecquet/Leaflet.RotatedMarker/master/leaflet.rotatedMarker.js"></script>

<script>
    // ------ MAP SETUP ------
    const map = L.map('mapDraw', {
        zoomControl: false, touchZoom: true, scrollWheelZoom: true, doubleClickZoom: true, boxZoom: false
    }).setView([58.333, 8.233], 13);

    L.tileLayer.wms('https://wms.geonorge.no/skwms1/wms.topo', {
        layers: 'topo', format: 'image/png', transparent: false, attribution: '© Kartverket'
    }).addTo(map);

    // Better on iPad when panel opens/closes
    const invalidateSoon = () => setTimeout(() => map.invalidateSize(), 220);
    window.addEventListener('resize', invalidateSoon);

    // Geoman
    map.pm.addControls({ drawMarker: false, drawPolyline: false, editMode: false, removalMode: false });
    if (map.pm?.Toolbar) map.pm.Toolbar.removeControls();

    // Layers for user geometry
    const drawn = L.featureGroup().addTo(map);

    // Locate
    const helicopterIcon = L.icon({ iconUrl: '/icons/helicopter.svg', iconSize: [45,45], iconAnchor: [19,19] });

    function locateUser() {
        map.locate({ setView: true, maxZoom: 18, enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
    }
    map.on("locationfound", e => {
        if (window.currentPosMarker) map.removeLayer(window.currentPosMarker);
        if (window.currentPosCircle) map.removeLayer(window.currentPosCircle);

        window.currentPosMarker = L.marker(e.latlng, { icon: helicopterIcon })
            .addTo(map)
            .bindPopup(`<b>Helikopterposisjon</b><br/>Nøyaktighet: ±${Math.round(e.accuracy)} m`)
            .openPopup();

        setTimeout(() => window.currentPosMarker && window.currentPosMarker.closePopup(), 3000);

        window.currentPosCircle = L.circle(e.latlng, {
            radius: Math.min(e.accuracy/2, 100), color: "blue", weight: 2, opacity: .6, fillOpacity: .15
        }).addTo(map);

        if (typeof e.heading === "number" && !isNaN(e.heading)) {
            window.currentPosMarker.setRotationAngle(e.heading);
        }
    });

    // Draw controls
    const btnLocate = document.getElementById("btnLocate");
    const btnPoint  = document.getElementById("btnDrawPoint");
    const btnLine   = document.getElementById("btnDrawLine");

    const resetActive = () => {
        [btnPoint, btnLine].forEach(b => b && b.classList.remove("ring-2","ring-emerald-400","scale-[.98]"));
    };
    const activate = (btn) => { resetActive(); btn && btn.classList.add("ring-2","ring-emerald-400","scale-[.98]"); };

    btnLocate?.addEventListener("click", () => { resetActive(); locateUser(); });

    function startDrawPoint(){ map.pm.disableDraw(); map.pm.enableDraw('Marker', { snappable:false }); }
    function startDrawLine(){  map.pm.disableDraw(); map.pm.enableDraw('Line',   { snappable:false }); }

    btnPoint?.addEventListener("click", () => { activate(btnPoint); startDrawPoint(); });
    btnLine ?.addEventListener("click", () => { activate(btnLine ); startDrawLine();  });

    // Limit line to 2 points
    map.on('pm:drawstart', ({ shape, workingLayer }) => {
        if (shape === 'Line') {
            workingLayer.on('pm:vertexadded', () => {
                const pts = workingLayer.getLatLngs();
                if (pts.length >= 2) {
                    if (map.pm?.Draw?.Line?._finishShape) map.pm.Draw.Line._finishShape();
                    else map.pm.disableDraw();
                }
            });
        }
    });

    // Only one geometry total
    map.on('pm:create', e => {
        drawn.clearLayers();
        drawn.addLayer(e.layer);
        map.pm.disableDraw();
        document.getElementById('GeoJsonCoordinates').value = JSON.stringify(e.layer.toGeoJSON().geometry);
        resetActive();
        saveDraft();
    });

    // Toast helpers
    function showToast(id) {
        const t = document.getElementById(id); if (!t) return;
        t.style.opacity = "1"; setTimeout(() => t.style.opacity = "0", 5000);
    }

    // ------ SLIDE-OVER PANEL ------
    const panel = document.getElementById('detailsPanel');
    const openBtn = document.getElementById('openPanelBtn');
    const closeBtn = document.getElementById('closePanelBtn');

    function openPanel(){ panel.classList.remove('translate-x-full'); invalidateSoon(); }
    function closePanel(){ panel.classList.add('translate-x-full');   invalidateSoon(); }

    openBtn?.addEventListener('click', openPanel);
    closeBtn?.addEventListener('click', closePanel);

    // ------ AUTOSAVE (comment + geometry) ------
    const formKey = "ObstacleReportForm";
    let draftDisabled = false;

    const commentField = document.querySelector('[name="ObstacleComment"]');
    function saveDraft(){
        if (draftDisabled) return;
        const geo = document.getElementById('GeoJsonCoordinates').value || "";
        const comment = commentField ? (commentField.value || "") : "";
        if (geo.trim().length > 0) localStorage.setItem(formKey, JSON.stringify({ comment, geoJson: geo }));
        else localStorage.removeItem(formKey);
    }
    commentField?.addEventListener('input', saveDraft);

    window.addEventListener('load', () => {
        const saved = localStorage.getItem(formKey); if (!saved) return;
        let data=null; try { data = JSON.parse(saved); } catch { localStorage.removeItem(formKey); return; }
        if (!data.geoJson) return;

        // restore comment
        if (data.comment && commentField) commentField.value = data.comment;
        // restore geometry
        document.getElementById('GeoJsonCoordinates').value = data.geoJson;
        try {
            const geom = JSON.parse(data.geoJson);
            drawn.clearLayers();
            if (geom.type === "Point") {
                const [lng, lat] = geom.coordinates;
                const m = L.marker([lat,lng]).addTo(map); drawn.addLayer(m); map.setView([lat,lng], 15);
            } else if (geom.type === "LineString") {
                const latlngs = geom.coordinates.map(([lng,lat]) => [lat,lng]);
                const l = L.polyline(latlngs, { color:"orange", weight:4 }).addTo(map);
                drawn.addLayer(l); map.fitBounds(l.getBounds());
            }
        } catch {}
        showToast('restoreToast');
    });

    // Clear draft on submit
    document.getElementById('submitBtn')?.addEventListener('click', () => {
        draftDisabled = true; localStorage.removeItem(formKey);
    });

    // Cancel/reset
    const cancelBtn = document.getElementById('cancelBtn');
    cancelBtn?.addEventListener('click', () => {
        draftDisabled = true; localStorage.removeItem(formKey);
        if (commentField) commentField.value = "";
        document.getElementById('GeoJsonCoordinates').value = "";
        drawn.clearLayers(); map.pm.disableDraw(); resetActive();
        if (window.currentPosMarker){ map.removeLayer(window.currentPosMarker); window.currentPosMarker=null; }
        if (window.currentPosCircle){ map.removeLayer(window.currentPosCircle); window.currentPosCircle=null; }
        closePanel(); showToast('cancelToast');
    });

    // ------ Image live preview ------
    const imgInput = document.querySelector('input[name="ImageFile"]');
    const imgWrap = document.getElementById('imgPreviewWrap');
    const imgPrev = document.getElementById('imgPreview');
    imgInput?.addEventListener('change', (e) => {
        const file = e.target.files?.[0];
        if (!file) { imgWrap?.classList.add('hidden'); imgPrev.src = ""; return; }
        const url = URL.createObjectURL(file);
        imgPrev.src = url; imgWrap?.classList.remove('hidden');
    });

    // Initial invalidate (some mobile browsers need a tick)
    setTimeout(() => map.invalidateSize(), 200);
</script>
}
