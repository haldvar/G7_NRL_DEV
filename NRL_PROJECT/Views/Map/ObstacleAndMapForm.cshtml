@model NRL_PROJECT.Models.ObstacleData

@section Styles {
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/@@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css" />
}

@{
    ViewBag.HideChrome = true;  // tells layout to hide header/footer
}

<form asp-action="SubmitObstacleWithLocation" asp-controller="Map" method="post" enctype="multipart/form-data">
    @Html.AntiForgeryToken()

    <!-- Hidden file input (triggered by Upload button) -->
    <input asp-for="ImageFile" type="file" accept="image/*" capture="environment"
           id="imageInput" class="hidden" />
    <!-- Keep this hidden field for GeoJSON -->
    <input type="hidden" asp-for="MapData.GeoJsonCoordinates" id="GeoJsonCoordinates" />

    <div class="min-h-[100svh] w-full p-4 md:p-6 bg-gradient-to-b from-green-100 to-blue-100">
        <div class="relative rounded-3xl border border-white/60 bg-white/40 backdrop-blur overflow-hidden shadow-xl
                    h-[calc(100svh-2rem)] md:h-[calc(100svh-3rem)]">

            <!-- MAP -->
            <div id="mapDraw" class="absolute inset-0 z-0" style="border-radius: inherit;"></div>

            <!-- Top bar (subtle) -->
            <div class="pointer-events-none absolute left-0 right-0 top-0 z-20 px-4 py-3">
                <div class="mx-auto max-w-7xl">
                    <div class="inline-flex items-center gap-3 rounded-full bg-white/80 backdrop-blur px-4 py-2
                                border border-white/70 shadow">
                        <span class="text-sm font-semibold text-green-700">Registrer hinder</span>
                        <span class="hidden text-xs text-gray-500 sm:inline">Marker punkt eller tegn en kort linje</span>
                    </div>
                </div>
            </div>

            <!-- Floating map tools: right side (draw) -->
            <div class="absolute bottom-6 right-4 z-20">
                <div class="flex flex-col items-center gap-4 rounded-[2rem] bg-white/40 backdrop-blur border border-white/60 p-3 shadow-lg">
                    <!-- Draw Point -->
                    <button id="btnDrawPoint" type="button"
                            class="h-24 w-24 md:h-28 md:w-28 rounded-full bg-white/85 backdrop-blur border border-white/70 shadow-lg
                                   hover:shadow-xl active:scale-95 transition inline-flex items-center justify-center"
                            title="Marker punkt">
                        <img src="/icons/map-pin.svg" alt="" class="h-12 w-12 md:h-14 md:w-14 opacity-90 pointer-events-none" />
                    </button>
                    <div class="h-px w-16 md:w-20 bg-white/60"></div>
                    <!-- Draw Line -->
                    <button id="btnDrawLine" type="button"
                            class="h-24 w-24 md:h-28 md:w-28 rounded-full bg-white/85 backdrop-blur border border-white/70 shadow-lg
                                   hover:shadow-xl active:scale-95 transition inline-flex items-center justify-center"
                            title="Tegn linje (2 punkter)">
                        <img src="/icons/line.svg" alt="" class="h-12 w-12 md:h-14 md:w-14 opacity-90 pointer-events-none" />
                    </button>
                </div>
            </div>

            <!-- Floating nav: top-right (home) -->
            <div class="absolute top-6 right-4 z-20">
                <a asp-area="" asp-controller="Home" asp-action="Index"
                   class="h-24 w-24 md:h-28 md:w-28 rounded-full bg-white/85 backdrop-blur border border-white/70 shadow-lg
                          hover:shadow-xl active:scale-95 transition inline-flex items-center justify-center"
                   title="Til forsiden" aria-label="Til forsiden">
                    <img src="/icons/home.svg" alt="" class="h-10 w-10 md:h-12 md:w-12 opacity-90 pointer-events-none" />
                </a>
            </div>

            <!-- Floating tools: left side (Upload + Comment + Locate) -->
            <div class="absolute bottom-6 left-4 z-20">
                <div class="flex flex-col items-center gap-4 rounded-[2rem] bg-white/40 backdrop-blur border border-white/60 p-3 shadow-lg">
                    <!-- Upload Image -->
                    <button id="btnUploadImage" type="button"
                            class="h-24 w-24 md:h-28 md:w-28 rounded-full bg-white/85 backdrop-blur border border-white/70 shadow-lg
                                   hover:shadow-xl active:scale-95 transition inline-flex items-center justify-center"
                            title="Last opp bilde">
                        <img src="/icons/kamera.svg" alt="" class="h-12 w-12 md:h-14 md:w-14 opacity-90 pointer-events-none" />
                    </button>

                    <div class="h-px w-16 md:w-20 bg-white/60"></div>

                    <!-- Comment -->
                    <button id="btnComment" type="button"
                            class="h-24 w-24 md:h-28 md:w-28 rounded-full bg-white/85 backdrop-blur border border-white/70 shadow-lg
                                   hover:shadow-xl active:scale-95 transition inline-flex items-center justify-center"
                            title="Legg til kommentar">
                        <img src="/icons/kommentar.svg" alt="" class="mt-2 h-12 w-12 md:h-14 md:w-14 opacity-90 pointer-events-none" />
                    </button>

                    <div class="h-px w-16 md:w-20 bg-white/60"></div>

                    <!-- Locate -->
                    <button id="btnLocate" type="button"
                            class="h-24 w-24 md:h-28 md:w-28 rounded-full bg-white/85 backdrop-blur border border-white/70 shadow-lg
                                   hover:shadow-xl active:scale-95 transition inline-flex items-center justify-center"
                            title="Finn min posisjon">
                        <img src="/icons/helicopter.svg" alt="" class="h-[60px] w-[60px] md:h-[70px] md:w-[70px] opacity-90 pointer-events-none" />
                    </button>
                </div>
            </div>

            <!-- Submit report button (center bottom) -->
            <div class="absolute bottom-6 left-1/2 -translate-x-1/2 z-20">
                <button type="submit" id="submitBtn"
                        class="inline-flex items-center gap-3 rounded-full bg-blue-600 px-16 py-10 
                               text-3xl font-semibold text-white shadow-lg hover:shadow-xl hover:bg-blue-700 
                               active:scale-95 transition">
                    <span class="leading-none">Meld hinder</span>
                    <svg xmlns="http://www.w3.org/2000/svg"
                         class="h-6 w-6 md:h-7 md:w-7" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                </button>
            </div>

            <!-- Toasts -->
            <div id="restoreToast"
                 class="pointer-events-none absolute left-1/2 top-4 z-40 -translate-x-1/2 rounded-xl bg-sky-600/95 px-5 py-3
                        text-white shadow-2xl font-semibold tracking-wide backdrop-blur transition-opacity duration-500"
                 style="opacity:0;">
                Utkast gjenopprettet
            </div>
            <div id="cancelToast"
                 class="pointer-events-none absolute left-1/2 top-20 z-40 -translate-x-1/2 rounded-xl bg-sky-600/95 px-5 py-3
                        text-white shadow-2xl font-semibold tracking-wide backdrop-blur transition-opacity duration-500"
                 style="opacity:0;">
                Rapport nullstilt
            </div>
            <!-- New: image attached toast -->
            <div id="imageToast"
                 class="pointer-events-none absolute left-1/2 top-36 z-40 -translate-x-1/2 rounded-xl bg-emerald-600/95 px-5 py-3
                        text-white shadow-2xl font-semibold tracking-wide backdrop-blur transition-opacity duration-500"
                 style="opacity:0;">
                Bilde vedlagt
            </div>

            <!-- Bottom comment sheet -->
            <div id="commentSheetBackdrop"
                 class="hidden absolute inset-0 z-30 bg-black/20"></div>

            <div id="commentSheet"
                 class="absolute left-0 right-0 bottom-0 z-40 translate-y-full transition-transform duration-300 ease-out">
                <div class="rounded-t-3xl border-t border-slate-200 bg-white/95 backdrop-blur shadow-2xl p-5">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-bold text-green-700">Kommentar</h3>
                        <button type="button" id="closeComment"
                                class="rounded-full p-2 hover:bg-gray-100 active:scale-95 transition" title="Lukk">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>

                    <div class="mt-3">
                        <label asp-for="ObstacleComment" class="block text-sm font-semibold text-gray-700">Kommentar</label>
                        <textarea asp-for="ObstacleComment" rows="4"
                                  class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-gray-900
                                         focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                  placeholder="Valgfritt"></textarea>
                        <span asp-validation-for="ObstacleComment" class="text-red-600 text-sm"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>


@if (!ViewData.ModelState.IsValid)
{
<div class="mx-auto max-w-2xl bg-red-600 text-white p-4 rounded-xl mt-6">
    <ul class="list-disc list-inside">
        @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
        {
        <li>@error.ErrorMessage</li>
        }
    </ul>
</div>
}

@section Scripts {
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"></script>
<script src="https://rawcdn.githack.com/bbecquet/Leaflet.RotatedMarker/master/leaflet.rotatedMarker.js"></script>

<script>
    // ------ MAP SETUP ------
    const map = L.map('mapDraw', {
        zoomControl: false, touchZoom: true, scrollWheelZoom: true, doubleClickZoom: true, boxZoom: false
    }); // ⬅ no .setView here

    L.tileLayer.wms('https://wms.geonorge.no/skwms1/wms.topo', {
        layers: 'topo', format: 'image/png', transparent: false, attribution: '© Kartverket'
    }).addTo(map);

    // Kick off geolocation immediately (or on DOM ready)
    function autoLocate() {
        map.locate({
            setView: true,       // center on user
            maxZoom: 18,         // cap zoom
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        });
    }
    autoLocate();

    // Keep the map tidy on resize
    const invalidateSoon = () => setTimeout(() => map.invalidateSize(), 220);
    window.addEventListener('resize', invalidateSoon);
    setTimeout(() => map.invalidateSize(), 200);

    // Geoman (no default toolbar)
    map.pm.addControls({ drawMarker: false, drawPolyline: false, editMode: false, removalMode: false });
    if (map.pm?.Toolbar) map.pm.Toolbar.removeControls();

    // Layers for user geometry
    const drawn = L.featureGroup().addTo(map);

    // Locate
    const helicopterIcon = L.icon({ iconUrl: '/icons/helicopter.svg', iconSize: [45,45], iconAnchor: [19,19] });
    function locateUser() {
        map.locate({ setView: true, maxZoom: 18, enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
    }
    map.on("locationfound", e => {
        map.setView(e.latlng, 18);
        
        if (window.currentPosMarker) map.removeLayer(window.currentPosMarker);
        if (window.currentPosCircle) map.removeLayer(window.currentPosCircle);

        window.currentPosMarker = L.marker(e.latlng, { icon: helicopterIcon })
            .addTo(map)
            // .bindPopup(`<b>Helikopterposisjon</b><br/>Nøyaktighet: ±${Math.round(e.accuracy)} m`)
            .openPopup();

        setTimeout(() => window.currentPosMarker && window.currentPosMarker.closePopup(), 3000);

        window.currentPosCircle = L.circle(e.latlng, {
            radius: Math.min(e.accuracy/2, 100), color: "blue", weight: 2, opacity: .6, fillOpacity: .15
        }).addTo(map);

        if (typeof e.heading === "number" && !isNaN(e.heading)) {
            window.currentPosMarker.setRotationAngle(e.heading);
        }
    });
    // Fallback location if user blocks location
    map.on("locationerror", () => {
        map.setView([64.5, 11.0], 5);
    });

    // Draw controls
    const btnLocate = document.getElementById("btnLocate");
    const btnPoint  = document.getElementById("btnDrawPoint");
    const btnLine   = document.getElementById("btnDrawLine");

    const resetActive = () => {
        [btnPoint, btnLine].forEach(b => b && b.classList.remove("ring-2","ring-emerald-400","scale-[.98]"));
    };
    const activate = (btn) => { resetActive(); btn && btn.classList.add("ring-2","ring-emerald-400","scale-[.98]"); };

    btnLocate?.addEventListener("click", () => { resetActive(); locateUser(); });

    function startDrawPoint(){ map.pm.disableDraw(); map.pm.enableDraw('Marker', { snappable:false }); }
    function startDrawLine(){  map.pm.disableDraw(); map.pm.enableDraw('Line',   { snappable:false }); }

    btnPoint?.addEventListener("click", () => { activate(btnPoint); startDrawPoint(); });
    btnLine ?.addEventListener("click", () => { activate(btnLine ); startDrawLine();  });

    // Limit line to 2 points
    map.on('pm:drawstart', ({ shape, workingLayer }) => {
        if (shape === 'Line') {
            workingLayer.on('pm:vertexadded', () => {
                const pts = workingLayer.getLatLngs();
                if (pts.length >= 2) {
                    if (map.pm?.Draw?.Line?._finishShape) map.pm.Draw.Line._finishShape();
                    else map.pm.disableDraw();
                }
            });
        }
    });

    // Only one geometry total
    map.on('pm:create', e => {
        drawn.clearLayers();
        drawn.addLayer(e.layer);
        map.pm.disableDraw();
        document.getElementById('GeoJsonCoordinates').value = JSON.stringify(e.layer.toGeoJSON().geometry);
        resetActive();
        saveDraft();
    });

    // ------ Upload image (hidden input trigger + toast) ------
    const imgInput = document.getElementById('imageInput');
    const btnUpload = document.getElementById('btnUploadImage');
    const imageToast = document.getElementById('imageToast');

    btnUpload?.addEventListener('click', () => imgInput?.click());
    imgInput?.addEventListener('change', (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        // Subtle toast
        imageToast.style.opacity = "1";
        setTimeout(() => imageToast.style.opacity = "0", 3500);
        saveDraft(); // keep draft behavior consistent
    });

    // ------ Comment bottom sheet ------
    const btnComment = document.getElementById('btnComment');
    const sheet = document.getElementById('commentSheet');
    const backdrop = document.getElementById('commentSheetBackdrop');
    const closeComment = document.getElementById('closeComment');

    function openSheet(){
        sheet.classList.remove('translate-y-full');
        backdrop.classList.remove('hidden');
        invalidateSoon();
    }
    function closeSheet(){
        sheet.classList.add('translate-y-full');
        backdrop.classList.add('hidden');
        invalidateSoon();
    }
    btnComment?.addEventListener('click', openSheet);
    closeComment?.addEventListener('click', closeSheet);
    backdrop?.addEventListener('click', closeSheet);

    // ------ SMART AUTOSAVE ------
    const formKey = "ObstacleReportForm";
    let draftDisabled = false;

    const commentField = document.querySelector('[name="ObstacleComment"]');
    function saveDraft(){
        if (draftDisabled) return;
        const geo = document.getElementById('GeoJsonCoordinates').value || "";
        const comment = commentField ? (commentField.value || "") : "";
        // Store a minimal draft when we have geometry (same behavior as before)
        if (geo.trim().length > 0) {
            localStorage.setItem(formKey, JSON.stringify({ comment, geoJson: geo }));
        } else {
            localStorage.removeItem(formKey);
        }
    }
    commentField?.addEventListener('input', saveDraft);

    window.addEventListener('load', () => {
        const saved = localStorage.getItem(formKey); if (!saved) return;
        let data=null; try { data = JSON.parse(saved); } catch { localStorage.removeItem(formKey); return; }
        if (!data.geoJson) return;

        // restore comment
        if (data.comment && commentField) commentField.value = data.comment;
        // restore geometry
        document.getElementById('GeoJsonCoordinates').value = data.geoJson;
        try {
            const geom = JSON.parse(data.geoJson);
            drawn.clearLayers();
            if (geom.type === "Point") {
                const [lng, lat] = geom.coordinates;
                const m = L.marker([lat,lng]).addTo(map); drawn.addLayer(m); map.setView([lat,lng], 15);
            } else if (geom.type === "LineString") {
                const latlngs = geom.coordinates.map(([lng,lat]) => [lat,lng]);
                const l = L.polyline(latlngs, { color:"orange", weight:4 }).addTo(map);
                drawn.addLayer(l); map.fitBounds(l.getBounds());
            }
        } catch {}
        // Blue toast
        const toast = document.getElementById("restoreToast");
        if (toast){ toast.style.opacity = "1"; setTimeout(() => toast.style.opacity = "0", 5000); }
    });

    // Clear draft on submit
    document.getElementById('submitBtn')?.addEventListener('click', () => {
        draftDisabled = true; localStorage.removeItem(formKey);
    });

    // Cancel/reset (if you keep a cancel somewhere else; harmless if missing)
    const cancelBtn = document.getElementById('cancelBtn');
    function showCancelToast() {
        const t = document.getElementById("cancelToast"); if (!t) return;
        t.style.opacity = "1"; setTimeout(() => t.style.opacity = "0", 5000);
    }
    cancelBtn?.addEventListener('click', () => {
        draftDisabled = true; localStorage.removeItem(formKey);
        if (commentField) commentField.value = "";
        document.getElementById('GeoJsonCoordinates').value = "";
        drawn.clearLayers(); map.pm.disableDraw(); resetActive();
        if (window.currentPosMarker){ map.removeLayer(window.currentPosMarker); window.currentPosMarker=null; }
        if (window.currentPosCircle){ map.removeLayer(window.currentPosCircle); window.currentPosCircle=null; }
        closeSheet(); showCancelToast();
    });
</script>
}

