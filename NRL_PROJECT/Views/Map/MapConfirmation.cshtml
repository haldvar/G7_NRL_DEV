@model NRL_PROJECT.Models.MapData

@{
    ViewData["Title"] = "Map Confirmation";
    Layout = "_Layout";
    int zoomLevel = Model.MapZoomLevel != 0 ? Model.MapZoomLevel : 12;

    // Fallback til f√∏rste koordinat hvis GeoJSON mangler
    var firstCoord = Model.Coordinates?.OrderBy(c => c.OrderIndex).FirstOrDefault();
    double fallbackLat = firstCoord?.Latitude ?? 60.0;
    double fallbackLng = firstCoord?.Longitude ?? 10.0;
}

<div class="max-w-4xl mx-auto px-4 py-10">
    <h1 class="text-4xl font-extrabold text-purple-700 text-center mb-4 tracking-wide">
        ‚úÖ Kartbekreftelse
    </h1>
    <p class="text-gray-600 text-center mb-8">
        Kartdataene du sendte inn er visualisert nedenfor.
    </p>

    <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
        <div id="mapConfirm" class="rounded-xl border border-gray-200 shadow-inner z-10" style="height: 450px;"></div>
        <p class="text-sm text-gray-500 mt-3">
            Kartet er sentrert p√• koordinatene du oppga.
        </p>
    </div>

    <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
        <h2 class="text-xl font-semibold text-purple-700 mb-3 flex items-center">
            üìç R√• kartdata
        </h2>
        <div id="rawDataContainer"
             class="bg-gray-50 p-4 rounded-lg text-sm text-gray-800 space-y-1 border border-gray-200">
            <div><em>Laster inn kartdata...</em></div>
        </div>
    </div>

    <div class="flex justify-center space-x-4">
        <a asp-action="Index" asp-controller="Home"
           class="bg-gray-600 text-white px-8 py-3 rounded-xl font-medium shadow-md hover:bg-gray-700 hover:shadow-lg transition">
            ‚¨ÖÔ∏è Tilbake til Hjem
        </a>
        <a asp-action="ObstacleAndMapForm" asp-controller="Map"
           class="bg-blue-600 text-white px-8 py-3 rounded-xl font-semibold shadow-md hover:bg-blue-700 hover:shadow-lg transition">
            üó∫Ô∏è Tegn p√• nytt
        </a>
        <a asp-action="ReportListOverview" asp-controller="Map"
           class="bg-gray-600 text-white px-8 py-3 rounded-xl font-medium shadow-md hover:bg-gray-700 hover:shadow-lg transition">
            Rapportoversikt
        </a>
    </div>
</div>

@section Scripts {
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const map = L.map('mapConfirm').setView([@fallbackLat, @fallbackLng], @zoomLevel);

        L.tileLayer.wms('https://wms.geonorge.no/skwms1/wms.topo', {
            layers: 'topo',
            format: 'image/png',
            transparent: false,
            attribution: '¬© Kartverket'
        }).addTo(map);

        const geoJsonRaw = '@Html.Raw(Model.GeoJsonCoordinates?.Replace("'", "\\'"))';

        if (geoJsonRaw && geoJsonRaw.length > 0) {
            try {
                const geometry = JSON.parse(geoJsonRaw);

                if (geometry.type === "Point") {
                    const [lng, lat] = geometry.coordinates;
                    L.marker([lat, lng]).addTo(map).bindPopup("Hinderpunkt").openPopup();
                    updateRawData([{ lat, lng }]);

                } else if (geometry.type === "LineString") {
                    const coords = geometry.coordinates;
                    const markerList = [];

                    coords.forEach((coord, i) => {
                        const [lng, lat] = coord;
                        markerList.push({ lat, lng });
                        L.marker([lat, lng]).addTo(map).bindPopup(`Mark√∏r ${i + 1}`);
                    });

                    const latlngs = coords.map(c => [c[1], c[0]]);
                    const line = L.polyline(latlngs, { color: 'orange', weight: 4 }).addTo(map);
                    map.fitBounds(line.getBounds());

                    updateRawData(markerList);
                }
            } catch (err) {
                console.error("Failed to parse GeoJSON:", err);
            }
        } else {
            // fallback: vis f√∏rste koordinat
            L.marker([@fallbackLat, @fallbackLng])
                .addTo(map)
                .bindPopup("Senterpunkt")
                .openPopup();

            updateRawData([{ lat: @fallbackLat, lng: @fallbackLng }]);
        }

        function updateRawData(markers) {
            const container = document.querySelector("#rawDataContainer");
            if (!container) return;

            let html = "";

            if (markers.length === 1) {
                html += `
                    <div><strong>Breddegrad (Latitude):</strong> ${markers[0].lat.toFixed(6)}</div>
                    <div><strong>Lengdegrad (Longitude):</strong> ${markers[0].lng.toFixed(6)}</div>
                    <div><strong>Type:</strong> Punkt</div>
                `;
            } else if (markers.length === 2) {
                html += `
                    <div><strong>Mark√∏r 1 Latitude:</strong> ${markers[0].lat.toFixed(6)}</div>
                    <div><strong>Mark√∏r 1 Longitude:</strong> ${markers[0].lng.toFixed(6)}</div>
                    <div><strong>Mark√∏r 2 Latitude:</strong> ${markers[1].lat.toFixed(6)}</div>
                    <div><strong>Mark√∏r 2 Longitude:</strong> ${markers[1].lng.toFixed(6)}</div>
                    <div><strong>Type:</strong> Linje (mellom 2 mark√∏rer)</div>
                `;
            }

            container.innerHTML = html;
        }
    </script>
}
