@model NRL_PROJECT.Models.MapData

@{
    ViewData["Title"] = "Register Map Location";
    Layout = "_Layout";
}

<!-- Inkluderer partial som tegner kart-div og skjult input -->
<partial name="_MapDrawPartial" model="Model" />

<!-- Tittel -->
<h1 class="text-5xl md:text-6xl font-extrabold text-purple-700 text-center mb-4 tracking-wide">
    üó∫Ô∏è Register Map Location
</h1>
<p class="text-gray-600 text-center text-lg md:text-xl mb-12">
    Draw a point or a line on the map below and submit your obstacle.
</p>

<!-- Skjema -->
<form method="post" asp-action="Submit" asp-controller="Map"
      class="flex flex-col md:flex-row justify-center space-y-4 md:space-y-0 md:space-x-6 z-10">
    <input type="hidden" id="geoInput" name="GeoJsonCoordinates" />

    <button type="submit"
            class="bg-green-600 text-white px-12 py-5 rounded-2xl font-semibold text-2xl md:text-3xl shadow-xl hover:bg-green-700 hover:shadow-2xl transition">
        ‚úÖ Submit Drawing
    </button>

    <a asp-action="Index" asp-controller="Home"
       class="bg-gray-600 text-white px-12 py-5 rounded-2xl font-semibold text-2xl md:text-3xl shadow-xl hover:bg-gray-700 hover:shadow-2xl transition">
        ‚ùå Cancel
    </a>
</form>

@section Styles {
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/@@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css" />
}

@section Scripts {
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"></script>
    <script>
        // Init kartet med f√∏rste punkt som startposisjon
        const map = L.map('mapDraw').setView([@Model.Latitude1, @Model.Longitude1], @Model.MapZoomLevel);

        // Hvis to punkter er satt, zoom til linjen
        if (@Model.Latitude2 != 0 && @Model.Longitude2 != 0) {
            map.fitBounds([
                [@Model.Latitude1, @Model.Longitude1],
                [@Model.Latitude2, @Model.Longitude2]
            ]);
        }

        // Legg til bakgrunnskart (WMS fra Kartverket)
               L.tileLayer.wms('https://wms.geonorge.no/skwms1/wms.topo', {
            layers: 'topo',
            format: 'image/png',
            transparent: false,
            attribution: '¬© Kartverket'
        }).addTo(map);


        // Aktiver tegneverkt√∏y
        map.pm.addControls({
            position: 'topleft',
            drawMarker: true,
            drawPolyline: true,
            drawPolygon: false,
            drawCircle: false,
            drawRectangle: false,
            editMode: true,
            removalMode: true
        });

        // N√•r bruker tegner nytt objekt
        map.on('pm:create', e => {
            const geojson = e.layer.toGeoJSON();
            // Lagre hele geometry (inkluderer type + koordinater)
            document.getElementById('geoInput').value = JSON.stringify(geojson.geometry);
        });

        // N√•r bruker fjerner tegning
        map.on('pm:remove', () => {
            document.getElementById('geoInput').value = '';
        });
    </script>
}
