@model NRL_PROJECT.Models.MapData

@{
    ViewData["Title"] = "Register Map Location";
    Layout = "_Layout";

    // Fallback til f√∏rste koordinat
    var firstCoord = Model.Coordinates?.OrderBy(c => c.OrderIndex).FirstOrDefault();
    double startLat = firstCoord?.Latitude ?? 60.3913;
    double startLng = firstCoord?.Longitude ?? 5.3221;
    int zoom = Model.MapZoomLevel != 0 ? Model.MapZoomLevel : 12;
}

<!-- Inkluderer partial som tegner kart-div og skjult input -->
<partial name="_MapDrawPartial" model="Model" />

<h1 class="text-5xl md:text-6xl font-extrabold text-purple-700 text-center mb-4 tracking-wide">
    üó∫Ô∏è Nylig innrapporterte luftfartshindre
</h1>
<p class="text-gray-600 text-center text-lg md:text-xl mb-12">
    Her vises luftfartshindre som er innmeldt den siste m√•neden. 
</p>

<form method="post" asp-action="Submit" asp-controller="Map"
      class="flex flex-col md:flex-row justify-center space-y-4 md:space-y-0 md:space-x-6 z-10">
    <input type="hidden" id="geoInput" name="GeoJsonCoordinates" />

    <a asp-action="ReportListOverview" asp-controller="Map"
            class="bg-green-600 text-white px-12 py-5 rounded-2xl font-semibold text-2xl md:text-3xl shadow-xl hover:bg-green-700 hover:shadow-2xl transition">
        üìãRapportoversikt
    </a>

    <a asp-action="ObstacleAndMapForm" asp-controller="Map"
       class="bg-green-600 text-white px-12 py-5 rounded-2xl font-semibold text-2xl md:text-3xl shadow-xl hover:bg-green-700 hover:shadow-2xl transition">
       ‚úÖ Registrer nytt hinder
    </a>
</form>

@section Styles {
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/@@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css" />
}

@section Scripts {
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"></script>
    <script>
        // Init kartet med f√∏rste koordinat
        const map = L.map('mapDraw').setView([@startLat, @startLng], @zoom);

        // Bakgrunnskart (Kartverket WMS)
        L.tileLayer.wms('https://wms.geonorge.no/skwms1/wms.topo', {
            layers: 'topo',
            format: 'image/png',
            transparent: false,
            attribution: '¬© Kartverket'
        }).addTo(map);

        // Aktiver tegneverkt√∏y
        map.pm.addControls({
            position: 'topleft',
            drawMarker: true,
            drawPolyline: true,
            drawPolygon: false,
            drawCircle: false,
            drawRectangle: false,
            editMode: true,
            removalMode: true
        });

        // N√•r bruker tegner nytt objekt
        map.on('pm:create', e => {
            const geojson = e.layer.toGeoJSON();
            document.getElementById('geoInput').value = JSON.stringify(geojson.geometry);
        });

        // N√•r bruker fjerner tegning
        map.on('pm:remove', () => {
            document.getElementById('geoInput').value = '';
        });

        // ---- Render reported obstacles (points and lines) ----
        // Build a JS array of reports with available geometry on the server side.
        const reportedItems = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
            (Model.ObstacleReports ?? Enumerable.Empty<NRL_PROJECT.Models.ObstacleReportData>())
                .Where(r => r.MapData != null && !string.IsNullOrWhiteSpace(r.MapData.GeoJsonCoordinates))
                .Select(r => new {
                    id = r.ObstacleReportID,
                    geometry = r.MapData.GeoJsonCoordinates,
                    geometryType = r.MapData.GeometryType,
                    comment = r.ObstacleReportComment,
                    user = string.IsNullOrEmpty(r.UserName) ? r.UserId : r.UserName,
                    date = r.ObstacleReportDate
                })
                .ToList()
        ));

        // Feature group to collect layers for fitBounds
        const reportsGroup = L.featureGroup().addTo(map);

        for (const rep of reportedItems) {
            try {
                // rep.geometry is a JSON string of the geometry object (e.g. {"type":"Point","coordinates":[lng,lat]})
                const geom = JSON.parse(rep.geometry);

                if (!geom || !geom.type) continue;

                if (geom.type === "Point") {
                    const coords = geom.coordinates; // [lng, lat]
                    if (Array.isArray(coords) && coords.length >= 2) {
                        const latlng = [coords[1], coords[0]];
                        const marker = L.marker(latlng, { title: `Report #${rep.id}` });
                        const popupHtml = `<strong>Report #${rep.id}</strong><br/>${rep.comment ? rep.comment : ''}<br/>${rep.user ? rep.user : ''}`;
                        marker.bindPopup(popupHtml);
                        marker.addTo(reportsGroup);
                    }
                } else if (geom.type === "LineString") {
                    const coords = geom.coordinates; // array of [lng, lat]
                    if (Array.isArray(coords) && coords.length > 0) {
                        const latlngs = coords.map(p => [p[1], p[0]]);
                        const poly = L.polyline(latlngs, { color: 'red', weight: 3, opacity: 0.8 });
                        const popupHtml = `<strong>Report #${rep.id}</strong><br/>${rep.comment ? rep.comment : ''}<br/>${rep.user ? rep.user : ''}`;
                        poly.bindPopup(popupHtml);
                        poly.addTo(reportsGroup);
                    }
                } else {
                    // optionally handle MultiPoint, MultiLineString etc.
                }
            } catch (ex) {
                // Ignore invalid geometry for robustness, but you can log via an endpoint if needed.
                console.warn('Invalid geometry for report', rep.id, ex);
            }
        }

        // If we added any reported layers, adjust view to include them
        if (reportsGroup.getLayers().length > 0) {
            map.fitBounds(reportsGroup.getBounds().pad(0.15));
        }
    </script>
}
