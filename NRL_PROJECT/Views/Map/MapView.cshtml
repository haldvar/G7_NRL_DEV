@model NRL_PROJECT.Models.MapData
@using System.Text.Json

@{
    ViewData["Title"] = "Register Map Location";
    Layout = "_Layout";

    // Fallback til f√∏rste koordinat
    var firstCoord = Model.Coordinates?.OrderBy(c => c.OrderIndex).FirstOrDefault();
    double startLat = firstCoord?.Latitude ?? 60.3913;
    double startLng = firstCoord?.Longitude ?? 5.3221;
    int zoom = Model.MapZoomLevel != 0 ? Model.MapZoomLevel : 12;

    // Lag en liste med rapporterte hindere i ren, serialiserbar form
    var reportedItems = (Model.ObstacleReports ?? Enumerable.Empty<NRL_PROJECT.Models.ObstacleReportData>())
        .Where(r => r.MapData != null && !string.IsNullOrWhiteSpace(r.MapData.GeoJsonCoordinates))
        .Select(r => new
        {
            id = r.ObstacleReportID,
            geometry = r.MapData.GeoJsonCoordinates,   // GeoJSON-streng
            geometryType = r.MapData.GeometryType,
            comment = r.ObstacleReportComment,
            user = string.IsNullOrEmpty(r.UserName) ? r.UserId : r.UserName,
            date = r.ObstacleReportDate
        })
        .ToList();
}

<!-- Kartet + form -->
<partial name="_MapDrawPartial" model="Model" />

<h1 class="text-5xl md:text-6xl font-extrabold text-purple-700 text-center mb-4 tracking-wide">
    üó∫Ô∏è Nylig innmeldte luftfartshindre
</h1>

<p class="text-gray-600 text-center text-lg md:text-xl mb-12">
    Her vises luftfartshindre som er innmeldt den siste m√•neden.
</p>

<form method="post" asp-action="Submit" asp-controller="Map"
      class="flex flex-col md:flex-row justify-center space-y-4 md:space-y-0 md:space-x-6 z-10">

    <input type="hidden" id="geoInput" name="GeoJsonCoordinates" />

    <a asp-action="ReportListOverview" asp-controller="Map"
       class="bg-green-600 text-white px-12 py-5 rounded-2xl font-semibold text-2xl md:text-3xl shadow-xl hover:bg-green-700 hover:shadow-2xl transition">
        üìã Hinderlogg
    </a>

    <a asp-action="ObstacleAndMapForm" asp-controller="Map"
       class="bg-green-600 text-white px-12 py-5 rounded-2xl font-semibold text-2xl md:text-3xl shadow-xl hover:bg-green-700 hover:shadow-2xl transition">
        ‚úÖ Meld nytt hinder
    </a>
</form>

@section Styles {
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/@@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css" />

    <style>
        .report-tooltip {
            font-weight: 700;
            font-size: 0.95rem;
            color: #111;
        }

        .label-control {
            font-size: 0.9rem;
            padding: 6px;
        }

            .label-control input {
                margin-right: 6px;
                vertical-align: middle;
            }

        .report-label-icon {
            pointer-events: auto;
        }

        .report-label-div {
            background: rgba(255,255,255,0.9);
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,0.06);
        }
    </style>
}

@section Scripts {
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"></script>

    <script>

        //--------------------------
        // Init kartet
        //--------------------------
        const map = L.map('mapDraw').setView([@startLat, @startLng], @zoom);

        L.tileLayer.wms('https://wms.geonorge.no/skwms1/wms.topo', {
            layers: 'topo',
            format: 'image/png',
            transparent: false,
            attribution: '¬© Kartverket'
        }).addTo(map);

        //--------------------------
        // Tegneverkt√∏y
        //--------------------------
        map.pm.addControls({
            position: 'topleft',
            drawMarker: true,
            drawPolyline: true,
            drawPolygon: false,
            drawCircle: false,
            drawRectangle: false,
            editMode: true,
            removalMode: true
        });

        map.on('pm:create', e => {
            const geojson = e.layer.toGeoJSON();
            document.getElementById('geoInput').value = JSON.stringify(geojson.geometry);
        });

        map.on('pm:remove', () => {
            document.getElementById('geoInput').value = '';
        });

        //--------------------------
        // Rapporter fra DB
        //--------------------------

        // JSON TRYGT serialisert via IJsonHelper
        const reportedItems = @Json.Serialize(reportedItems);

        const reportsGroup = L.featureGroup().addTo(map);
        const labelMarkers = [];
        let showLabelClick = true;

        // Kontroll for toggle av click p√• labels
        const labelControl = L.control({ position: 'topright' });
        labelControl.onAdd = function () {
            const container = L.DomUtil.create('div', 'label-control bg-white rounded shadow p-2');
            container.innerHTML = '<label><input id="labelToggle" type="checkbox" checked /> Show report on label click</label>';
            L.DomEvent.disableClickPropagation(container);
            return container;
        };
        labelControl.addTo(map);

        document.addEventListener('DOMContentLoaded', () => {
            const toggle = document.getElementById('labelToggle');
            if (toggle) {
                toggle.addEventListener('change', e => showLabelClick = e.target.checked);
            }
        });

        for (const rep of reportedItems) {
            try {
                const geom = JSON.parse(rep.geometry);

                if (!geom || !geom.type) continue;

                const popupHtml =
                    `<strong>Report #${rep.id}</strong><br/>${rep.comment || ""}<br/>${rep.user || ""}`;
                const tooltipHtml = `<span class="report-tooltip">Report #${rep.id}</span>`;

                if (geom.type === "Point") {
                    const [lng, lat] = geom.coordinates;
                    const marker = L.marker([lat, lng], { title: `Report #${rep.id}` });

                    marker.bindPopup(popupHtml);
                    marker.bindTooltip(tooltipHtml, { sticky: true, direction: 'top' });
                    marker.addTo(reportsGroup);
                }
                else if (geom.type === "LineString") {
                    const latlngs = geom.coordinates.map(p => [p[1], p[0]]);
                    const poly = L.polyline(latlngs, { color: 'red', weight: 3, opacity: 0.8 });

                    poly.bindPopup(popupHtml);
                    poly.bindTooltip(tooltipHtml, { sticky: true });

                    const midIndex = Math.floor(latlngs.length / 2);
                    const mid = latlngs[midIndex];

                    if (mid) {
                        const label = L.marker(mid, {
                            interactive: true,
                            icon: L.divIcon({
                                className: 'report-label-div report-label-icon',
                                html: `<div class="report-label-div">#${rep.id}</div>`,
                                iconSize: [40, 18]
                            })
                        });

                        label.on('click', () => {
                            if (showLabelClick) {
                                L.popup({ offset: [0, -10] })
                                    .setLatLng(label.getLatLng())
                                    .setContent(popupHtml)
                                    .openOn(map);
                            }
                        });

                        labelMarkers.push(label);
                        label.addTo(reportsGroup);
                    }

                    poly.addTo(reportsGroup);
                }
            }
            catch (err) {
                console.warn("Invalid geometry for report:", rep.id, err);
            }
        }

        // Fit bounds hvis rapporter finnes
        if (reportsGroup.getLayers().length > 0) {
            map.fitBounds(reportsGroup.getBounds().pad(0.15));
        }
    </script>
}
