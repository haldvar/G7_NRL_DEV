@model NRL_PROJECT.Models.MapData
@using System.Text.Json

@{
    ViewData["Title"] = "Register Map Location";
    Layout = "_Layout";
    ViewBag.HideChrome = true;

    var firstCoord = Model.Coordinates?.OrderBy(c => c.OrderIndex).FirstOrDefault();
    double startLat = firstCoord?.Latitude ?? 60.3913;
    double startLng = firstCoord?.Longitude ?? 5.3221;
    int zoom = Model.MapZoomLevel != 0 ? Model.MapZoomLevel : 12;

    // PRIVACY: Check if user is Admin OR Registrar
    bool canSeePilotInfo = User.IsInRole("Admin") || User.IsInRole("Registrar");

    var reportedItems = (Model.ObstacleReports ?? Enumerable.Empty<NRL_PROJECT.Models.ObstacleReportData>())
        .Where(r => r.MapData != null && !string.IsNullOrWhiteSpace(r.MapData.GeoJsonCoordinates))
        .Select(r => new
        {
            id = r.ObstacleReportID,
            geometry = r.MapData.GeoJsonCoordinates,
            geometryType = r.MapData.GeometryType,
            comment = r.ObstacleReportComment,
            
            // PRIVACY: Show username to Admins and Registrars only
            user = canSeePilotInfo && r.SubmittedByUser != null 
                ? r.SubmittedByUser.UserName 
                : "Anonym bruker",
            
            // PRIVACY: Show full name to Admins and Registrars only
            fullName = canSeePilotInfo && r.SubmittedByUser != null
                ? $"{r.SubmittedByUser.FirstName} {r.SubmittedByUser.LastName}"
                : null,
                
            date = r.ObstacleReportDate.ToString("dd.MM.yyyy HH:mm")
        })
        .ToList();
}

<div class="min-h-[100svh] w-full bg-gradient-to-b from-green-100 to-blue-100 p-4 md:p-6">
    <div class="relative mx-auto max-w-7xl rounded-3xl border border-white/60 bg-white/40 backdrop-blur shadow-xl overflow-hidden
                h-[calc(100svh-2rem)] md:h-[calc(100svh-3rem)]">

        <!-- MAP CONTAINER -->
        <div id="mapDraw" class="absolute inset-0 z-0" style="border-radius: inherit;"></div>

        <!-- HOME BUTTON (TOP RIGHT) -->
        <div class="absolute top-6 right-4 z-20">
            <a asp-area="" asp-controller="Home" asp-action="Index"
               class="h-16 w-16 md:h-20 md:w-20 rounded-full bg-white/85 backdrop-blur border border-white/70 shadow-lg
                      hover:shadow-xl active:scale-95 transition inline-flex items-center justify-center"
               title="Til forsiden" aria-label="Til forsiden">
                <img src="/icons/home.svg" alt="Hjem" class="h-9 w-9 opacity-90 pointer-events-none" />
            </a>
        </div>

        <!-- TITLE (TOP CENTER) -->
        <div class="pointer-events-none absolute left-1/2 top-6 z-20 -translate-x-1/2">
            <div class="inline-flex items-center gap-2 rounded-full bg-white/85 backdrop-blur px-5 py-3
                        border border-white/70 text-green-700 font-semibold shadow">
                Nylig innrapporterte luftfartshindre
            </div>
        </div>

        <!-- ACTION BUTTONS (BOTTOM CENTER) -->
        <div class="absolute bottom-6 left-1/2 z-20 -translate-x-1/2">
            <div class="flex flex-col md:flex-row items-center gap-3 md:gap-4">
                <a asp-action="MyReports" asp-controller="Map"
                   class="inline-flex items-center justify-center rounded-full bg-gray-700 px-6 md:px-8 py-3 md:py-4
                          text-white text-base md:text-lg font-semibold shadow hover:bg-gray-800 transition">
                    Mine rapporter
                </a>
                <a asp-action="ObstacleAndMapForm" asp-controller="Map"
                   class="inline-flex items-center justify-center rounded-full bg-blue-600 px-6 md:px-8 py-3 md:py-4
                          text-white text-base md:text-lg font-semibold shadow hover:bg-blue-700 transition">
                    Meld hinder
                </a>
            </div>
        </div>

        <!-- PRIVACY NOTICE (BOTTOM LEFT) - Only show for users who can't see pilot info -->
        @if (!canSeePilotInfo)
        {
            <div class="absolute bottom-6 left-4 z-20">
                <div class="rounded-xl bg-blue-50/95 backdrop-blur px-4 py-2 border border-blue-200 shadow-lg max-w-xs">
                    <div class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                        </svg>
                        <span class="text-sm text-blue-900 font-medium">Pilotinformasjon er anonymisert</span>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<form method="post" asp-action="Submit" asp-controller="Map" class="hidden">
    <input type="hidden" id="geoInput" name="GeoJsonCoordinates" />
</form>

@section Styles {
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/@@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css" />
    <style>
        .report-tooltip {
            font-weight: 700;
            font-size: 0.95rem;
            color: #111;
        }

        .report-label-icon {
            pointer-events: auto;
        }

        .report-label-div {
            background: rgba(255,255,255,0.9);
            padding: 2px 6px;
            border-radius: 6px;
            border: 1px solid rgba(0,0,0,0.06);
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            font-weight: 600;
        }

        /* Popup styling */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            padding: 12px;
        }

        .popup-header {
            font-weight: 700;
            font-size: 1.1rem;
            color: #047857;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 2px solid #10b981;
        }

        .popup-field {
            margin: 6px 0;
            font-size: 0.9rem;
        }

        .popup-label {
            font-weight: 600;
            color: #374151;
        }

        .popup-value {
            color: #6b7280;
        }

        /* Anonymous user styling */
        .anonymous-user {
            font-style: italic;
            color: #9ca3af;
        }
    </style>
}

@section Scripts {
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"></script>

    <script>
        // MAP INITIALIZATION
        const map = L.map('mapDraw', { zoomControl: true }).setView([58.333, 8.233], 13);
        map.zoomControl.setPosition('bottomright');

        L.tileLayer.wms('https://wms.geonorge.no/skwms1/wms.topo', {
            layers: 'topo',
            format: 'image/png',
            transparent: false,
            attribution: 'Â© Kartverket'
        }).addTo(map);

        if (map.pm?.Toolbar) map.pm.Toolbar.removeControls();

        // LOAD REPORT DATA
        const reportedItems = @Json.Serialize(reportedItems);
        const reportsGroup = L.featureGroup().addTo(map);
        const canSeePilotInfo = @Json.Serialize(canSeePilotInfo);

        // BUILD POPUP CONTENT
        function buildPopupContent(rep) {
            let html = '<div class="space-y-2">';
            
            // Report header
            html += '<div class="popup-header">Rapport #' + rep.id + '</div>';
            
            // Date
            html += '<div class="popup-field">';
            html += '<span class="popup-label">Dato:</span> ';
            html += '<span class="popup-value">' + rep.date + '</span>';
            html += '</div>';
            
            // Comment
            if (rep.comment) {
                html += '<div class="popup-field">';
                html += '<span class="popup-label">Kommentar:</span> ';
                html += '<span class="popup-value">' + rep.comment + '</span>';
                html += '</div>';
            }
            
            // PRIVACY: Only show user info to Admins and Registrars
            if (canSeePilotInfo && rep.fullName) {
                html += '<div class="popup-field">';
                html += '<span class="popup-label">Meldt av:</span> ';
                html += '<span class="popup-value">' + rep.fullName + ' (' + rep.user + ')</span>';
                html += '</div>';
            }
            
            html += '</div>';
            
            return html;
        }

        // RENDER REPORTS ON MAP
        for (const rep of reportedItems) {
            try {
                const geom = JSON.parse(rep.geometry);
                if (!geom) continue;

                const popupHtml = buildPopupContent(rep);
                const tooltipHtml = '<span class="report-tooltip">#' + rep.id + '</span>';

                // Case 1: RAW GEOMETRY (UI)
                if (geom.type === "Point") {
                    const [lng, lat] = geom.coordinates;
                    const m = L.marker([lat, lng]);
                    m.bindPopup(popupHtml);
                    m.bindTooltip(tooltipHtml, { sticky: true, direction: 'top' });
                    m.addTo(reportsGroup);
                    continue;
                }

                if (geom.type === "LineString") {
                    const latlngs = geom.coordinates.map(([lng, lat]) => [lat, lng]);
                    const poly = L.polyline(latlngs, { color: 'red', weight: 3, opacity: 0.85 }).addTo(reportsGroup);
                    poly.bindPopup(popupHtml);
                    poly.bindTooltip(tooltipHtml, { sticky: true });

                    const mid = latlngs[Math.floor(latlngs.length / 2)];
                    if (mid) {
                        const label = L.marker(mid, {
                            icon: L.divIcon({
                                className: 'report-label-icon',
                                html: '<div class="report-label-div">#' + rep.id + '</div>',
                                iconSize: [42, 20]
                            })
                        }).addTo(reportsGroup);

                        label.on('click', () => {
                            L.popup({ offset: [0, -10] })
                                .setLatLng(label.getLatLng())
                                .setContent(popupHtml)
                                .openOn(map);
                        });
                    }
                    continue;
                }

                // Case 2: FEATURE (seeding)
                if (geom.type === "Feature" && geom.geometry?.type === "Point") {
                    const [lng, lat] = geom.geometry.coordinates;
                    const m = L.marker([lat, lng]);
                    m.bindPopup(popupHtml);
                    m.bindTooltip(tooltipHtml, { sticky: true, direction: 'top' });
                    m.addTo(reportsGroup);
                    continue;
                }

                if (geom.type === "Feature" && geom.geometry?.type === "LineString") {
                    const latlngs = geom.geometry.coordinates.map(([lng, lat]) => [lat, lng]);
                    const poly = L.polyline(latlngs, { color: 'red', weight: 3, opacity: 0.85 }).addTo(reportsGroup);
                    poly.bindPopup(popupHtml);
                    poly.bindTooltip(tooltipHtml, { sticky: true });

                    const mid = latlngs[Math.floor(latlngs.length / 2)];
                    if (mid) {
                        const label = L.marker(mid, {
                            icon: L.divIcon({
                                className: 'report-label-icon',
                                html: '<div class="report-label-div">#' + rep.id + '</div>',
                                iconSize: [42, 20]
                            })
                        }).addTo(reportsGroup);

                        label.on('click', () => {
                            L.popup({ offset: [0, -10] })
                                .setLatLng(label.getLatLng())
                                .setContent(popupHtml)
                                .openOn(map);
                        });
                    }
                    continue;
                }

            } catch (err) {
                console.warn("Invalid geometry for report:", rep?.id, err);
            }
        }

        // FIT MAP TO REPORTS
        if (reportsGroup.getLayers().length > 0) {
            map.fitBounds(reportsGroup.getBounds().pad(0.15));
        }

        // MAP SIZE FIXES
        setTimeout(() => map.invalidateSize(), 200);
        window.addEventListener('resize', () => setTimeout(() => map.invalidateSize(), 150));
    </script>
}
