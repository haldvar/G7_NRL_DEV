@model IEnumerable<ObstacleReportViewModel>
@using System.Globalization
@using EnumStatus = NRL_PROJECT.Models.EnumStatus
@using NRL_PROJECT.Models.ViewModels

@{
    Layout = "_Layout";

    var ci   = CultureInfo.InvariantCulture;
    var list = Model.ToList();

    int cNy        = list.Count(x => x.ReportStatus == EnumStatus.Ny);
    int cVenter    = list.Count(x => x.ReportStatus == EnumStatus.Venter);
    int cUnderBeh  = list.Count(x => x.ReportStatus == EnumStatus.UnderBehandling);
    int cGodkjent  = list.Count(x => x.ReportStatus == EnumStatus.Godkjent);
    int cAvvist    = list.Count(x => x.ReportStatus.ToString() == "Avvist");

    var selectedStatus = (string)Context.Request.Query["status"];
    if (string.IsNullOrWhiteSpace(selectedStatus)) selectedStatus = "Alle";

    var SelectedType   = (string)Context.Request.Query["type"];
    var currentSearch  = (string)Context.Request.Query["q"];
}

<div class="min-h-[100svh] w-full bg-gradient-to-b from-green-100 to-blue-100">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8">

        <!-- Page heading -->
        <header class="mb-6 flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
            <div>
                <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight text-green-700">
                    Innrapporterte hinder
                </h1>
                <p class="mt-1 text-sm text-slate-600">
                    Behandle og filtrer rapporter. Klikk på et kort for detaljer og oppfølging.
                </p>
            </div>
            <div class="h-1 w-44 rounded-full bg-gradient-to-r from-green-600 via-blue-600 to-green-600"></div>
        </header>

        <!-- Content grid -->
        <div class="grid grid-cols-1 gap-6 lg:grid-cols-12">

            <!-- LEFT SIDEBAR -->
            <aside class="space-y-6 lg:col-span-3">

                <!-- Search -->
                <div class="rounded-2xl border border-white/60 bg-white/90 backdrop-blur p-4 shadow">
                    <h3 class="mb-2 text-base font-semibold text-slate-800">Søk</h3>
                    <form method="get" asp-action="RegistrarView" asp-controller="Registrar" class="flex items-center gap-2">
                        <input type="hidden" name="status" value="@selectedStatus" />
                        <input type="hidden" name="type" value="@SelectedType" />

                        <input name="q"
                               value="@currentSearch"
                               type="search"
                               placeholder="Søk på ID, type eller navn…"
                               class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />

                        <button type="submit"
                                class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50">
                            Søk
                        </button>
                    </form>
                </div>

                <!-- Quick folders (optional) -->
                <div class="rounded-2xl border border-white/60 bg-white/90 backdrop-blur p-4 shadow">
                    <h3 class="mb-3 text-base font-semibold text-slate-800">Meldinger</h3>
                    <div class="grid gap-2">
                        <button type="button" class="w-full rounded-xl border border-slate-200 bg-slate-50 px-4 py-2 text-sm text-slate-700 hover:bg-white">Innboks</button>
                        <button type="button" class="w-full rounded-xl border border-slate-200 bg-slate-50 px-4 py-2 text-sm text-slate-700 hover:bg-white">Sendt</button>
                        <button type="button" class="w-full rounded-xl border border-slate-200 bg-slate-50 px-4 py-2 text-sm text-slate-700 hover:bg-white">Kladd</button>
                    </div>
                </div>

                <!-- Registrars action -->
                <div class="rounded-2xl border border-white/60 bg-white/90 backdrop-blur p-4 shadow">
                    <h3 class="mb-3 text-base font-semibold text-slate-800">Registerførere</h3>
                    <button type="button"
                            class="w-full rounded-xl border border-blue-200 bg-white px-4 py-2 text-sm font-semibold text-blue-700 hover:bg-blue-50">
                        Samhandling registerførere
                    </button>
                </div>
            </aside>

            <!-- RIGHT COLUMN: LIST -->
            <section class="space-y-4 lg:col-span-9">

                <!-- Filter bar -->
                <div class="flex flex-col gap-3 rounded-2xl border border-white/60 bg-white/90 backdrop-blur px-4 py-3 shadow sm:flex-row sm:items-center sm:justify-between">
                    <div class="flex flex-wrap items-center gap-2 text-sm">
                        <span class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-slate-50 px-3 py-1 font-semibold text-slate-700">
                            Totalt
                            <span class="rounded-full bg-white px-2 py-0.5 text-slate-900">@list.Count</span>
                        </span>
                        <span class="inline-flex items-center gap-2 rounded-full border border-amber-200 bg-amber-50 px-3 py-1 font-semibold text-amber-800">
                            Ny <span class="rounded-full bg-white px-2 py-0.5">@cNy</span>
                        </span>
                        <span class="inline-flex items-center gap-2 rounded-full border border-sky-200 bg-sky-50 px-3 py-1 font-semibold text-sky-800">
                            Venter <span class="rounded-full bg-white px-2 py-0.5">@cVenter</span>
                        </span>
                        <span class="inline-flex items-center gap-2 rounded-full border border-indigo-200 bg-indigo-50 px-3 py-1 font-semibold text-indigo-800">
                            Under beh. <span class="rounded-full bg-white px-2 py-0.5">@cUnderBeh</span>
                        </span>
                        <span class="inline-flex items-center gap-2 rounded-full border border-emerald-200 bg-emerald-50 px-3 py-1 font-semibold text-emerald-800">
                            Godkjent <span class="rounded-full bg-white px-2 py-0.5">@cGodkjent</span>
                        </span>
                        <span class="inline-flex items-center gap-2 rounded-full border border-rose-200 bg-rose-50 px-3 py-1 font-semibold text-rose-800">
                            Avvist <span class="rounded-full bg-white px-2 py-0.5">@cAvvist</span>
                        </span>
                    </div>

                    <!-- Filter dropdown -->
                    <form method="get" asp-action="RegistrarView" asp-controller="Registrar" class="flex items-center gap-2">
                        <label for="statusFilter" class="text-sm text-slate-700">Filtrer:</label>

                        <select id="statusFilter" name="status"
                                class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                onchange="this.form.submit()">
                            <option value="Alle"             selected="@(selectedStatus == "Alle")">Alle (@list.Count)</option>
                            <option value="Ny"               selected="@(selectedStatus == "Ny")">Ny (@cNy)</option>
                            <option value="Venter"           selected="@(selectedStatus == "Venter")">Venter (@cVenter)</option>
                            <option value="UnderBehandling"  selected="@(selectedStatus == "UnderBehandling")">Under behandling (@cUnderBeh)</option>
                            <option value="Godkjent"         selected="@(selectedStatus == "Godkjent")">Godkjent (@cGodkjent)</option>
                            <option value="Avvist"           selected="@(selectedStatus == "Avvist")">Avvist (@cAvvist)</option>
                        </select>

                        <input type="hidden" name="q"    value="@currentSearch" />
                        <input type="hidden" name="type" value="@SelectedType" />
                    </form>
                </div>

                <!-- Report cards -->
                @if (!list.Any())
                {
                    <div class="rounded-2xl border border-white/60 bg-white/90 backdrop-blur p-8 text-center text-slate-600 shadow">
                        Ingen rapporter funnet. Juster filtre eller søk.
                    </div>
                }
                else
                {
                    int index = 0;
                    foreach (var r in list)
                    {
                        var bgClass = index % 2 == 0 ? "bg-white/95" : "bg-slate-50/95";
                        
                        <a asp-controller="Registrar"
                           asp-action="ReportDetails"
                           asp-route-id="@r.ObstacleReportID"
                           asp-route-status="@selectedStatus"
                           asp-route-q="@currentSearch"
                           class="block rounded-2xl border border-white/60 @bgClass backdrop-blur p-4 shadow transition hover:-translate-y-0.5 hover:shadow-md">
                            
                            <!-- Accent -->
                            <div class="h-1 w-full rounded-t-2xl bg-gradient-to-r from-green-600 via-blue-600 to-green-600 mb-3"></div>

                            <div class="flex items-start justify-between gap-4">
                                <!-- LEFT: Text -->
                                <div class="min-w-0 flex-1">
                                    <div class="text-sky-700 font-semibold">Rapport #@r.ObstacleReportID</div>
                                    <div class="mt-0.5 text-base font-bold text-slate-900 truncate">
                                        @(string.IsNullOrWhiteSpace(r.ObstacleType) ? "Ukjent type" : r.ObstacleType)
                                    </div>

                                    <div class="mt-1 text-sm text-slate-600">
                                        @r.Latitude.ToString("0.######", ci), @r.Longitude.ToString("0.######", ci)
                                        <span class="mx-2">•</span>
                                        <span class="text-slate-500">Innmeldt:</span>
                                        @r.ObstacleReportDate.ToString("dd.MM.yyyy HH:mm")
                                    </div>

                                    <div class="mt-1 text-sm text-slate-600">
                                        <span class="text-slate-500">Innsender:</span> @r.UserName
                                    </div>

                                    @if (!string.IsNullOrWhiteSpace(r.OrgName))
                                    {
                                        <div class="mt-1 text-sm text-slate-600">
                                            <span class="text-slate-500">Organisasjon:</span> @r.OrgName
                                        </div>
                                    }

                                    @if (!string.IsNullOrWhiteSpace(r.ObstacleReportComment) && 
                                         r.ObstacleReportComment != "Her skal Registerfører kunne skrive inn kommentar.")
                                    {
                                        <div class="mt-2 text-sm text-slate-600">
                                            <span class="text-slate-500">Registerfører:</span>
                                            <span class="text-slate-700">@r.ObstacleReportComment</span>
                                        </div>
                                    }
                                </div>

                                <!-- RIGHT: Meta & thumb -->
                                <div class="flex shrink-0 flex-col items-end gap-2 text-sm text-slate-600">
                                    <div class="w-fit">@await Html.PartialAsync("_EnumTypes", r.ReportStatus)</div>

                                    <div>
                                        <span class="font-semibold">Høyde:</span>
                                        @(r.ObstacleHeight.HasValue && r.ObstacleHeight > 0
                                            ? r.ObstacleHeight.Value.ToString("0.##", ci) + " m"
                                            : "—")
                                    </div>

                                    <div>
                                        <span class="font-semibold">Reg.fører:</span>
                                        @(string.IsNullOrWhiteSpace(r.ReviewerName) ? "Ikke tildelt" : r.ReviewerName)
                                    </div>

                                    @if (!string.IsNullOrWhiteSpace(r.ObstacleImageURL))
                                    {
                                        <img src="@r.ObstacleImageURL"
                                             alt="Hinderbilde"
                                             class="mt-2 h-16 w-16 rounded object-cover border shadow" />
                                    }
                                    else
                                    {
                                        <span class="mt-2 text-xs text-slate-400">Ingen bilde</span>
                                    }
                                </div>
                            </div>
                        </a>
                        
                        index++;
                    }
                }
            </section>
        </div>
    </div>
</div>
