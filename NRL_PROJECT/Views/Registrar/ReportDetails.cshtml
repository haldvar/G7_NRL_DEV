@model NRL_PROJECT.Models.ObstacleReportViewModel
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@using System.Globalization
@using System.Text.Json

@{
    ViewData["Title"] = "Rapportdetaljer";
    var inv = CultureInfo.InvariantCulture;

    var hasCoords = !string.IsNullOrWhiteSpace(Model.GeoJsonCoordinates)
                    || (Model.MapData?.Coordinates?.Any() == true)
                    || (Model.Latitude != 0 && Model.Longitude != 0);

    var latlngList = new List<double[]>();
    if (Model.MapData?.Coordinates?.Any() == true)
    {
        foreach (var c in Model.MapData.Coordinates.OrderBy(c => c.OrderIndex))
            latlngList.Add(new[] { c.Latitude, c.Longitude });
    }
    else if (Model.Latitude != 0 || Model.Longitude != 0)
    {
        latlngList.Add(new[] { Model.Latitude, Model.Longitude });
    }
    var latlngsJson = JsonSerializer.Serialize(latlngList);
}

<div class="max-w-6xl px-10 py-10 space-y-6">

    <!-- Heading -->
    <header class="flex items-end justify-between">
        <div>
            <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight text-green-700">Rapportdetaljer</h1>
            <p class="mt-1 text-slate-600">ID #@Model.ObstacleReportID</p>
        </div>
        <div class="h-2 w-40 rounded-full bg-gradient-to-r from-green-600 to-blue-600"></div>
    </header>

    <!-- GRID: Status & Assign (map sits below assign) -->
    <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">

        <!-- LEFT COLUMN -->
        <div class="space-y-6 lg:col-span-2">

            <!-- ðŸ”„ Endre status (no comment field here) -->
            <div class="rounded-2xl border border-slate-200/70 bg-white/90 shadow-sm">
                <div class="border-b border-slate-200/70 px-5 py-3">
                    <h2 class="text-slate-800 font-semibold">Endre status</h2>
                </div>
                <div class="p-5">
                    <form asp-controller="Registrar" asp-action="UpdateStatus" method="post" class="space-y-4">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@Model.ObstacleReportID" />

                        <div class="flex flex-wrap gap-3">
                            <button name="status" value="UnderBehandling" type="submit"
                                    class="inline-flex items-center gap-2 rounded-xl bg-amber-500 px-4 py-2 text-white shadow-sm hover:bg-amber-600">
                                Under behandling
                            </button>
                            <button name="status" value="Godkjent" type="submit"
                                    class="inline-flex items-center gap-2 rounded-xl bg-emerald-600 px-4 py-2 text-white shadow-sm hover:bg-emerald-700">
                                Godkjenn
                            </button>
                            <button name="status" value="Avvist" type="submit"
                                    class="inline-flex items-center gap-2 rounded-xl bg-rose-600 px-4 py-2 text-white shadow-sm hover:bg-rose-700">
                                Avvis
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- ðŸ’¬ Save comment (separate form) -->
            <div class="rounded-2xl border border-slate-200/70 bg-white/90 shadow-sm">
                <div class="border-b border-slate-200/70 px-5 py-3">
                    <h2 class="text-slate-800 font-semibold">Kommentar</h2>
                </div>
                <div class="p-5">
                    <form asp-controller="Registrar" asp-action="SaveComment" method="post" class="space-y-3">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@Model.ObstacleReportID" />

                        <textarea asp-for="ObstacleReportComment" rows="3"
                      class="w-full rounded-xl border border-slate-300/80 bg-white px-3 py-2 text-sm
                             focus:outline-none focus:ring-2 focus:ring-blue-500"
                      placeholder="Kommentar (valgfritt)"></textarea>
                        <span asp-validation-for="ObstacleReportComment" class="text-red-600 text-sm"></span>

                        <button type="submit"
                                class="inline-flex items-center gap-2 rounded-xl bg-blue-600 px-4 py-2 text-white shadow-sm hover:bg-blue-700">
                            Lagre kommentar
                        </button>
                    </form>
                </div>
            </div>

            <!-- OverfÃ¸r rapport -->
            @{
                var registrarList = ViewBag.Registrars as List<SelectListItem> ?? new();
            }
            <div class="rounded-2xl border border-slate-200/70 bg-white/90 shadow-sm">
                <div class="border-b border-slate-200/70 px-5 py-3">
                    <h2 class="text-slate-800 font-semibold">Tildel registerfÃ¸rer</h2>
                </div>
                <div class="p-5">
                    <form asp-controller="Registrar" asp-action="TransferReport" method="post"
                          class="grid grid-cols-1 gap-3 sm:grid-cols-3">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@Model.ObstacleReportID" />

                        <div class="sm:col-span-2">
                            <select name="transferToUserId" asp-items="registrarList"
                                    class="w-full rounded-xl border border-slate-300/80 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">â€” Velg registerfÃ¸rer â€”</option>
                            </select>
                        </div>

                        <div class="sm:col-span-1">
                            <button type="submit"
                                    class="w-full rounded-xl bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-700">
                                OverfÃ¸r
                            </button>
                        </div>
                    </form>

                    <div class="mt-3 text-sm text-slate-700">
                        NÃ¥ tildelt:
                        <b>@(registrarList.FirstOrDefault(x => x.Value == Model.AssignedRegistrarUserID)?.Text ?? "Ingen")</b>
                        <span class="text-slate-400">(Navn: @Model.ReviewerName)</span>
                    </div>
                </div>
            </div>

            <!-- MAP (directly under assign) -->
            <div class="rounded-2xl border border-slate-200/70 bg-white/90 shadow-sm">
                <div class="border-b border-slate-200/70 px-5 py-3">
                    <h2 class="text-slate-800 font-semibold">Kart</h2>
                </div>
                <div class="p-5">
                    @if (hasCoords)
                    {
                        <div id="map" class="w-full rounded-xl border border-slate-200" style="height: 420px;"></div>
                    }
                    else
                    {
                        <div class="text-sm text-slate-500">Ingen koordinater i rapporten.</div>
                    }
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: Details (no quick facts card) -->
        <div class="lg:col-span-1">
            <div class="rounded-2xl border border-slate-200/70 bg-white/90 shadow-sm">
                <div class="border-b border-slate-200/70 px-5 py-3">
                    <h2 class="text-slate-800 font-semibold">Metadata</h2>
                </div>

                <div class="px-6 py-6">
                    <dl class="grid grid-cols-1 gap-x-6 gap-y-4 text-sm sm:grid-cols-2">

                        <div class="sm:col-span-1">
                            <dt class="font-semibold text-slate-700">Rapport ID</dt>
                            <dd>@Model.ObstacleReportID</dd>

                            <dt class="mt-3 font-semibold text-slate-700">Status</dt>
                            <dd>@await Html.PartialAsync("_EnumTypes", Model.ReportStatus)</dd>

                            <dt class="mt-3 font-semibold text-slate-700">Hindertype</dt>
                            <dd>
                                @{
                                    var typeTxt = string.IsNullOrWhiteSpace(Model.ObstacleType) ? "Ukjent" : Model.ObstacleType;
                                    var harHoyde = Model.ObstacleHeight.HasValue && Model.ObstacleHeight > 0;
                                    var typeItems = ViewBag.ObstacleTypes as List<SelectListItem> ?? new();
                                }

                                <div class="flex items-start justify-between gap-2">
                                    <div>
                                        <div>@typeTxt</div>
                                        @if (harHoyde)
                                        {
                                            <div class="text-sm text-slate-500">
                                                HÃ¸yde: @Model.ObstacleHeight?.ToString("0.##", inv) m
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="text-sm text-slate-400 italic">HÃ¸yde ikke satt</div>
                                        }
                                    </div>

                                    <button type="button"
                                            class="rounded border border-slate-300 px-2 py-1 text-xs hover:bg-slate-50"
                                            onclick="document.getElementById('edit-hindring').classList.toggle('hidden')">
                                        Rediger
                                    </button>
                                </div>

                                <!-- Inline edit -->
                                <div id="edit-hindring" class="mt-3 hidden">
                                    <form asp-controller="Registrar" asp-action="UpdateObstacleData" method="post" class="flex flex-col gap-2">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@Model.ObstacleReportID" />

                                        <label class="text-sm text-slate-600">Type</label>
                                        <select id="type-select" name="obstacleType" asp-items="typeItems" class="form-select">
                                            <option value="">â€” Velg type â€”</option>
                                        </select>

                                        <input id="customType" name="obstacleType" type="text"
                                               class="form-control mt-1" placeholder="Annen type..."
                                               style="display:none" />

                                        <label class="mt-2 text-sm text-slate-600">HÃ¸yde (m)</label>
                                        <input name="obstacleHeight"
                                               type="number" step="0.01" min="0" max="10000"
                                               class="w-32 rounded border border-slate-300 px-2 py-1 text-sm"
                                               value="@(Model.ObstacleHeight?.ToString(inv) ?? "")" />

                                        <div class="mt-2 flex gap-2">
                                            <button type="submit" class="rounded bg-blue-600 px-3 py-1 text-xs text-white hover:bg-blue-700">Lagre</button>
                                            <button type="button"
                                                    class="rounded border border-slate-300 px-3 py-1 text-xs hover:bg-slate-50"
                                                    onclick="document.getElementById('edit-hindring').classList.add('hidden')">
                                                Avbryt
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </dd>
                        </div>

                        <div class="sm:col-span-2">
                            <dt class="font-semibold text-slate-700">Lokasjon</dt>
                            <dd>
                                @if (Model.MapData?.Coordinates?.Any() == true)
                                {
                                    foreach (var c in Model.MapData.Coordinates.OrderBy(c => c.OrderIndex))
                                    {
                                        <div>@c.Latitude.ToString("F6"), @c.Longitude.ToString("F6")</div>
                                    }
                                }
                                else if (Model.Latitude != 0 && Model.Longitude != 0)
                                {
                                    <div>@Model.Latitude.ToString("F6"), @Model.Longitude.ToString("F6")</div>
                                }
                                else
                                {
                                    <span class="text-slate-400">Ingen koordinater</span>
                                }
                            </dd>
                        </div>

                        <div class="sm:col-span-2">
                            <dt class="font-semibold text-slate-700">Beskrivelse</dt>
                            <dd>@(Model.ObstacleComment ?? "-")</dd>
                        </div>

                        <div class="sm:col-span-2">
                            <dt class="font-semibold text-slate-700">Bilde</dt>
                            <dd>
                                @if (!string.IsNullOrWhiteSpace(Model.ObstacleImageURL))
                                {
                                    <a href="@Model.ObstacleImageURL" target="_blank">
                                        <img src="@Model.ObstacleImageURL"
                                             class="mt-2 h-48 w-auto rounded-xl border shadow object-cover"
                                             alt="Hinderbilde" />
                                    </a>
                                }
                                else
                                {
                                    <span class="text-slate-400 italic">Ingen bilde</span>
                                }
                            </dd>
                        </div>

                        <div>
                            <dt class="font-semibold text-slate-700">Tidspunkt registrert</dt>
                            <dd>@Model.ObstacleReportDate.ToString("dd.MM.yyyy HH:mm")</dd>
                        </div>

                        <div class="sm:col-span-2">
                            <dt class="font-semibold text-slate-700">Innsender</dt>
                            <dd>@Model.UserName</dd>
                        </div>

                        <div class="sm:col-span-2">
                            <dt class="font-semibold text-slate-700">Organisasjon</dt>
                            <dd>@Model.OrgName</dd>
                        </div>
                    </dl>

                    <div class="mt-4">
                        <a asp-action="RegistrarView"
                           class="inline-flex items-center rounded-xl border border-slate-300 px-4 py-2 text-sm hover:bg-slate-50">
                            Tilbake
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@if (hasCoords)
{
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
        (function () {
            const latlngs = @Html.Raw(@latlngsJson); // [[lat, lng], ...]

            if (!Array.isArray(latlngs) || latlngs.length === 0) return;

            const map = L.map('map', { zoomControl: true });

            // Kartverket WMS
            L.tileLayer.wms('https://wms.geonorge.no/skwms1/wms.topo', {
                layers: 'topo',
                format: 'image/png',
                transparent: false,
                attribution: 'Â© Kartverket'
            }).addTo(map);

            if (latlngs.length === 1) {
                const ll = latlngs[0];
                L.marker(ll).addTo(map);
                map.setView(ll, 15);
            } else {
                latlngs.forEach(ll => L.marker(ll).addTo(map));
                L.polyline(latlngs, { weight: 3, color: '#2563eb' }).addTo(map);
                map.fitBounds(L.latLngBounds(latlngs).pad(0.2));
            }
        })();
    </script>
}

@{
    // Build up toasts (supports multiple keys)
    var toastList = new List<(string Kind, string Text)>();
    void AddToast(string key, string kind) { if (TempData[key] is string v && !string.IsNullOrWhiteSpace(v)) toastList.Add((kind, v)); }
    AddToast("Success", "success");
    AddToast("Error", "error");
    AddToast("StatusChanged", "success");
    AddToast("RegistrarAssigned", "success");
}

@if (toastList.Any())
{
    <div id="nrl-toasts" class="fixed top-4 left-1/2 -translate-x-1/2 z-50 space-y-3">
        @foreach (var t in toastList)
        {
            var bg = t.Kind == "error" ? "bg-rose-600/95" : "bg-emerald-600/95";
            <div class="nrl-toast pointer-events-auto rounded-xl @bg px-5 py-3 text-white shadow-2xl backdrop-blur font-semibold">
                @t.Text
            </div>
        }
    </div>

    <script>
        // Auto-dismiss toasts after 4s with fade
        setTimeout(() => {
            document.querySelectorAll('#nrl-toasts .nrl-toast').forEach(el => {
                el.style.transition = 'opacity 400ms ease';
                el.style.opacity = '0';
                setTimeout(() => el.remove(), 500);
            });
        }, 4000);
    </script>
}
